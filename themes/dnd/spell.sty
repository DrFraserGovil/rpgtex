%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Internal key processing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RpgSpellAddProperty{school}{\l_SpellSchool}{}
\RpgSpellAddProperty{level}{\l__rpg_dnd_spell_level_tl}{0}
\RpgSpellAddProperty{casting-time}{\l__rpg_dnd_spell_casting_time_tl}{1~action}
\RpgSpellAddProperty{range}{\l__rpg_dnd_spell_range_tl}{self}
\RpgSpellAddProperty {components}{\l__rpg_dnd_spell_components_tl}{VSM}
\RpgSpellAddProperty{duration}{\l__rpg_dnd_spell_duration_tl}{Instantaneous}
\RpgSpellAddProperty{source}{\l__rpg_dnd_spell_source_tl}{}

\cs_new_protected:Npn \__rpg_dnd_spell_header:nn#1#2
{
	\ignorespaces
	\int_compare:nTF{#1 = 0}
	{
		\str_if_empty:nF{#2}{#2~}Cantrip
	}
	{
		\RpgOrdinal{#1}~level\str_if_empty:nF{#2}{~#2}
	}
}

\NewDocumentCommand{\FormatSpellHeading}{m}
{

	{\centering
		
		{
			\RpgFontCardHeader\scriptsize
			\__rpg_dnd_spell_header:nn {\l__rpg_dnd_spell_level_tl}{\l_SpellSchool}
		}
		{\\\RpgFontCardTitle\color{titlered}\mbox{#1}}
		
		\vspace{-0.5em} \\

		\rule{\linewidth}{0.4pt} \\

		\vspace{-0.25em}

		
		{\RpgFontCardHeader
		\begin{tabularx}{\linewidth}{YY}
			% \centering
			\color{titlered}Casting~time & \color{titlered}Range
			\\
			 \l__rpg_dnd_spell_casting_time_tl & \l__rpg_dnd_spell_range_tl
			\\
			\color{titlered}Components & \color{titlered} Duration
			\\
			 \l__rpg_dnd_spell_components_tl & \l__rpg_dnd_spell_duration_tl
		\end{tabularx}
		}
		}

}
\NewDocumentCommand{\AddSpellSource}{}{
		\str_if_empty:NF {\l__rpg_dnd_spell_source_tl}{
		
		\vfill 
			\hfil{\it  Source:~\l__rpg_dnd_spell_source_tl} \hfil
		%%For some reason \centering has no effect, so manually force centering via hfil
		}
}

\RpgSpellCardFormat
{
	\setlength{\parindent}{0pt}
		
		\FormatSpellHeading{#1}
		
		\\ \vspace{0.5em}
		\rule{\linewidth}{0.4pt} 
		\\ 
		\vspace{0.5em}
		
		\RpgFontCardBody

		#2
		
		\AddSpellSource{}
		
}


\RpgSpellTextFormat{
	\subsection{#1}
		
		\textit{\__rpg_dnd_spell_header:nn {\l__rpg_dnd_spell_level_tl}{\l_SpellSchool}}
		\par \vspace{3pt} \noindent \ignorespaces

		\begin{description}
		[
			nosep,
			labelsep = \l__rpg_space_dim,
			after    = { \vspace{4pt plus 1pt minus 1pt} },
		]
				\item [ Casting~time : ] \l__rpg_dnd_spell_casting_time_tl
				\item [ Range       : ] \l__rpg_dnd_spell_range_tl
				\item [ Components  : ] \l__rpg_dnd_spell_components_tl
				\item [ Duration    : ] \l__rpg_dnd_spell_duration_tl
				\str_if_empty:NF {\l__rpg_dnd_spell_source_tl}{\item [ Source      : ] \textit{\l__rpg_dnd_spell_source_tl}
		} 
		\end{description}
}
