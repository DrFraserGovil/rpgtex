%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Internal key processing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\int_new:N \l__rpg_dnd_spell_level_tl
\keys_define:nn {rpg/dnd/spell}
{
	level .code:n ={\int_set:Nn{\l__rpg_dnd_spell_level_tl}{#1}},
	level .initial:n = 0,
}
\__rpg_add_tl_keys:Nn {rpg/dnd/spell}
{
	\__rpg_tl_key:nnn {school}{\l__rpg_dnd_spell_school_tl}{}
	\__rpg_tl_key:nnn {casting-time}{\l__rpg_dnd_spell_casting_time_tl}{1~action}
	\__rpg_tl_key:nnn {range}{\l__rpg_dnd_spell_range_tl}{self}
	\__rpg_tl_key:nnn {components}{\l__rpg_dnd_spell_components_tl}{VSM}
	\__rpg_tl_key:nnn {duration}{\l__rpg_dnd_spell_duration_tl}{Instantaneous}
	\__rpg_tl_key:nnn {source}{\l__rpg_dnd_spell_source_tl}{}

}


\cs_new_protected:Npn \__rpg_dnd_spell_header:nn#1#2
{
	\ignorespaces
	\int_compare:nTF{#1 = 0}
	{
		\str_if_empty:nF{#2}{#2~}Cantrip
	}
	{
		\RpgOrdinal{#1}~level\str_if_empty:nF{#2}{~#2}
	}
}

\NewDocumentCommand{\FormatSpellHeading}{m}
{

	{\centering
		
		{
			\RpgFontCardHeader\scriptsize
			\__rpg_dnd_spell_header:nn {\l__rpg_dnd_spell_level_tl}{\l__rpg_dnd_spell_school_tl}
		}
		{\\\RpgFontCardTitle\color{titlered}\mbox{#1}}
		
		\vspace{-0.5em} \\

		\rule{\linewidth}{0.4pt} \\

		\vspace{-0.25em}

		
		{\RpgFontCardHeader
		\begin{tabularx}{\linewidth}{YY}
			% \centering
			\color{titlered}Casting~time & \color{titlered}Range
			\\
			 \l__rpg_dnd_spell_casting_time_tl & \l__rpg_dnd_spell_range_tl
			\\
			\color{titlered}Components & \color{titlered} Duration
			\\
			 \l__rpg_dnd_spell_components_tl & \l__rpg_dnd_spell_duration_tl
		\end{tabularx}
		}
		}

}
\NewDocumentCommand{\AddSpellSource}{}{
		\str_if_empty:NF {\l__rpg_dnd_spell_source_tl}{
		
		\vfill 
			\hfil{\it  Source:~\l__rpg_dnd_spell_source_tl} \hfil
		%%For some reason \centering has no effect, so manually force centering via hfil
		}
}

\NewDocumentEnvironment{__SpellCard}{O{} m +b}
{
	\setlength{\parindent}{0pt}
	\begin{RpgCard}[#1,opacity=0.4]
		
		\FormatSpellHeading{#2}
		
		\\ \vspace{0.5em}
		\rule{\linewidth}{0.4pt} 
		\\ 
		\vspace{0.5em}
		
		\RpgFontCardBody

		#3
		
		\AddSpellSource{}
		
}{
	\end{RpgCard}
}

\NewDocumentEnvironment{__SpellText}{m}
{
	\subsection{#1}
	
	\textit{\__rpg_dnd_spell_header:nn {\l__rpg_dnd_spell_level_tl}{\l__rpg_dnd_spell_school_tl}}
	\par \vspace{3pt} \noindent \ignorespaces

	 \begin{description}
      [
        nosep,
        labelsep = \l__rpg_space_dim,
        after    = { \vspace{4pt plus 1pt minus 1pt} },
      ]
			\item [ Casting~time : ] \l__rpg_dnd_spell_casting_time_tl
			\item [ Range       : ] \l__rpg_dnd_spell_range_tl
			\item [ Components  : ] \l__rpg_dnd_spell_components_tl
			\item [ Duration    : ] \l__rpg_dnd_spell_duration_tl
			\str_if_empty:NF {\l__rpg_dnd_spell_source_tl}{\item [ Source      : ] \textit{\l__rpg_dnd_spell_source_tl}
	  } 
    \end{description}
}{
	% \par{\it \spellsource}
}


\NewDocumentEnvironment{RpgSpell}{O{} m m}
{
	\keys_set:nn {rpg/dnd/spell}{#3}
	\begin{RpgSwitchEnv}{UseSpellCard}[#1]{__SpellCard}{__SpellText}{#2}
}{
	\end{RpgSwitchEnv}
}
