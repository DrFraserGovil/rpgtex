%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Internal key processing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RpgSpellAddProperty{school}{\l_SpellSchool}{}
\RpgSpellAddProperty{level}{\l__rpg_dnd_spell_level_tl}{0}
\RpgSpellAddProperty{casting-time}{\l__rpg_dnd_spell_casting_time_tl}{1~action}
\RpgSpellAddProperty{range}{\l__rpg_dnd_spell_range_tl}{self}
\RpgSpellAddProperty {components}{\l__rpg_dnd_spell_components_tl}{VSM}
\RpgSpellAddProperty{duration}{\l__rpg_dnd_spell_duration_tl}{Instantaneous}
\RpgSpellAddProperty{source}{\l__rpg_dnd_spell_source_tl}{}

\cs_new_protected:Npn \__rpg_dnd_spell_header:nn#1#2
{
	\ignorespaces
	\int_compare:nTF{#1 = 0}
	{
		\str_if_empty:nF{#2}{#2~}Cantrip
	}
	{
		\RpgOrdinal{#1}~level\str_if_empty:nF{#2}{~#2}
	}
}

\NewDocumentCommand{\FormatSpellHeading}{m}
{

	{\centering
		
		{
			\RpgFontCardHeader\scriptsize
			\__rpg_dnd_spell_header:nn {\getkey{level}}{\getkey{school}}
		}
		{\\\RpgFontCardTitle\color{titlered}\mbox{#1}}
		
		\vspace{-0.5em} \\

		\rule{\linewidth}{0.4pt} \\

		\vspace{-0.25em}

		
		{\RpgFontCardHeader
		\begin{tabularx}{\linewidth}{YY}
			\color{titlered}Casting~time 	& 		\color{titlered}Range
			\\
			\getkey{casting-time}			&	 	\getkey{range}
			\\
			\color{titlered}Components 		& 		\color{titlered} Duration
			\\
			\getkey{components}				& 		\getkey{duration}
		\end{tabularx}
		}
		}

}
\NewDocumentCommand{\AddSpellSource}{}{
		\tl_if_blank:eF {\l__rpg_dnd_spell_source_tl}{
		\vfill 
			\hfil{\it  Source:~(\l__rpg_dnd_spell_source_tl)} \hfil
		%%For some reason \centering has no effect, so manually force centering via hfil
		}
}

\RpgSpellCardFormat
{
	\setlength{\parindent}{0pt}
		
		\FormatSpellHeading{#1}
		
		\\ \vspace{0.5em}
		\rule{\linewidth}{0.4pt} 
		\\ 
		\vspace{0.5em}
		
		\RpgFontCardBody

		#2
		
		\AddSpellSource{}
		
}


\RpgSpellTextFormat{
	\subsection{#1}
		
		\textit{\__rpg_dnd_spell_header:nn {\getkey{level}}{\getkey{school}}}
		\par \vspace{3pt} \noindent \ignorespaces

		\begin{description}
		[
			nosep,
			labelsep = \l__rpg_space_dim,
			after    = { \vspace{4pt plus 1pt minus 1pt} },
		]
				\item [ Casting~time : ] \getkey{casting-time}
				\item [ Range       : ] \getkey{range}
				\item [ Components  : ] \getkey{components}
				\item [ Duration    : ] \getkey{duration}
				\tl_if_blank:eF {\l__rpg_dnd_spell_source_tl}{\item [ Source      : ] \textit{\getkey{source}}
		} 
		\end{description}

		#2
}

\NewDocumentCommand\RpgSpellUpcast{O{The~damage~increases~by} m  O{1}}
{
	\subparagraph{At~higher~levels} #1~#2~for~every~\str_compare:eNeF{#3}{=}{1}{#3~}\RpgPlural*{#3}{spell~level}~above~\RpgOrdinal{\l__rpg_dnd_spell_level_tl}~used~to~cast~this~spell.
}
\NewDocumentCommand\RpgCantripScaling{O{Damage} m m m m}
{
	This~cantrip~improves~with~your~character~level:
	% \begin{RpgTable}{lX}
	% 	Level & #1\\
	% 	1st & #2
	% 	\\
	% 	5th & #3
	% 	\\
	% 	11th & #4
	% 	\\
	% 	17th & #5
	% \end{RpgTable}
	\begin{RpgTable}{X Y Y Y Y}
		{ Level} & 1st & 5th & 11th & 17th
		\\
		{\RpgFontTableHeader  #1} & #2 & #3 & #4 & #5
	\end{RpgTable}
}
