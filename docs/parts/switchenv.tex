\chapter{Switchable Environments}\label{S:SwitchEnv}

    Often it is convenient to be able to toggle between two different environments depending on an external flag. In the context of an RPG this might be for a number of reasons: having a player version and a GM version, or having a screen-readable version versus a printable one. 

    Whilst it is obviously possible to build an environment which performs the switching for you, we provide a generic interface for switching between \textit{similar environments}.

    \begin{RpgSidebar}{'Similar' Environments}
        It is important to note that this system only works for switching between environments which are `similar', insofar as they permit the same number and order of arguments, and interpret their contents similarly.

        An itemize and an enumerate are `similar': an itemize and a figure are not.
    \end{RpgSidebar}

    The overall goal of the RpgSwitchEnv is to reduce the amount of duplication that an author has to do to get the same text in multiple different forms. The system was originally designed for the \texttt{RpgCard} environment, to enable the same text to be written 'in the book' and 'on the card' with minimal duplication. 

    \labelsection{RpgSwitchEnv}
    \RpgMacro*{RpgSwitchEnv}{\param{m o m o m}}
        {
            Acts as one of two similar environments based on the value of an input key.
        }{
            \cmd{begin}\param{RpgSwitchEnv}\param{<key>}[opt-1]\param{env-1}[opt-2]\param{env-2}

            ~~<contents>

            \cmd{end}\param{RpgSwitchEnv}
        }{
            The \texttt{key} is an input token (a string) which should be in the global \textit{switch-registry} (see below). The value associated with that key determines the behaviour of the Switch-Env:
            \begin{description}
                \item[Value is true] The environment acts as \texttt{env-1} (with optional arguments \texttt{[opt-1]})
                \item[Value is false] The environment acts as \texttt{env-2[opt-2]}.
            \end{description}
            Due to the way that token expansion works, it is possible to pass \textit{additional} arguments to this environment:
            \begin{Code}
                \cmd{begin}\param{RpgSwitchEnv}\param{<key>}[opt-1]\param{env-1}[opt-2]\param{env-2}\param{arg1}\param{arg2}
            \end{Code}
            Formally speaking, \texttt{arg1} and \texttt{arg2} are a part of the body of the environment; however if both env-1 and env-2 are expecting two arguments, then the token expansion captures them. It is also possible to use a shared optional argument, instead of the unique arguments:
            \begin{Code}
                \cmd{begin}\param{RpgSwitchEnv}\param{<key>}\param{env-1}\param{env-2}[shared-opt]
            \end{Code}
            If however, the environments are not similar, and take different numbers of arguments then any excess arguments are inserted into the body of the environment, which can cause unexpected behaviour.

            An error is thrown if \texttt{key} does not exist in the global registry.
        }
        \RpgMacro{RpgSetSwitch}{\param{m m}}
            {Change the value of a \textit{switch}, and therefore the behaviour of the associated RpgSwitchEnv}{\cmd{RpgSetSwitch}\param{<key>}\param{<value>}}
            {
                Sets the value of the \texttt{key} in the \textit{switch-registry} to \texttt{{value}}, which must be a 'bool-ish' text string\footnote{That is, either \param{true,True,1} or \param{false,False,0}}. If the entry does not exist in the registry, it is created.

                After the key is set, all subsequent \texttt{RpgSwitchEnv} calls which use that key will have their behaviour altered to match the new key.
            }
        \RpgMacro{RpgSetAllSwitches}{\param{m}}
            {
                 As with \cmd{RpgSetSwitch}, but iterates over all keys in the registry, and assigns the all the same \texttt{value}.
            }{}{}
% \begin{figure}
\begin{ExampleBlock}[RpgSwitchEnv]{Example Switching Environment}
  \def\exampleSwitch{
      \begin{RpgSwitchEnv}{test}{enumerate} [leftmargin=1cm]{itemize}
        \item item 1
        \item item 2
        \item orangutans
      \end{RpgSwitchEnv}
  }
  Changing the switch makes the same contents appear differently:

  \RpgSetSwitch{test}{true}
  \exampleSwitch{}

  \RpgSetSwitch{test}{false}
  \exampleSwitch{}

  %%Now repeat, but move the optional arg to the end as a 'hanging argument' 

  \def\exampleSwitch{
      \begin{RpgSwitchEnv}{test}{enumerate} {itemize}[leftmargin=1cm]
        \item item 1
        \item item 2
        \item orangutans
      \end{RpgSwitchEnv}
  }
   Both environments should now be indented:
  \RpgSetSwitch{test}{true}
  \exampleSwitch{}

  \RpgSetSwitch{test}{false}
  \exampleSwitch{}
\end{ExampleBlock}
% \end{figure}
    \labelsection{RpgSecret}

        The RpgSecret environment uses the RpgSwitchEnv system to conditionally hide information; this allows a Game Master\footnote{Or whatever your system calls this role!} to use the same text for their own notes as they would for players, but wall off some parts of it as 'not for their eyes'. 

        Internally, the \texttt{RpgSecret} is switching between a `hide' environment and a `show', which render the provided text in different ways:

        \begin{Code}
            \cmd{begin}\param{RpgSecret} --> \cmd{begin}\param{RpgSwitchEnv}\param{ShowSecrets}\param{\_\_showEnv}\param{\_\_hideEnv} (\ldots)
        \end{Code}


        \begin{figure}
        \def\fmt{\color{gray!60}\small}
\def\lorumIpsumOne{{\fmt{}Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Ut purus elit,
 vestibulum ut, placerat ac, adipiscing vitae, felis. Curabitur dictum gravida mauris. }}
 \def\lorumIpsumTwo{{\fmt{}Nam arcu libero, nonummy eget,
consectetuer id, vulputate a, magna. Donec vehicula augue eu neque.
Pellentesque habitant morbi tristique senectus et netus et malesuada
fames ac turpis egestas. }}
\def\lorumIpsumThree{{\fmt{}Mauris ut leo. Cras viverra metus rhoncus
sem. Nulla et lectus vestibulum urna fringilla ultrices. Phasellus eu
tellus sit amet tortor gravida placerat. Integer sapien est, iaculis in,
pretium quis, viverra ac, nunc. }}
\begin{ExampleBlock}[false,RpgSecret,RpgSetSwitch]{RpgSecrets (in hide-mode)}
 %%hide the juicy gossip
 \RpgSetSwitch{ShowSecrets}{false}
 
 \lorumIpsumOne%Snippets of standard lorum ipsum
 \begin{RpgSecret}{}
   The players don't know it yet, but all this pseudo-latin text is a hint that devils are involved!  
 \end{RpgSecret}
  \lorumIpsumTwo{}
  \begin{RpgSecret}{
    Logos kykloforia, thelxis kai ethos, tyrannis kai epilysis. Aei thera plaka, kyrios meion egestas, anagkas proin eira kai thera.
    }
   
    This bit of text is noteworthy - it's been added in after the fact
 \end{RpgSecret}
  \lorumIpsumThree
\end{ExampleBlock}
        
\begin{ExampleBlock}[true,RpgSecret,RpgShowSecrets]{RpgSecrets (in show-mode)}
 %%exactly the same as above -- but reveal the secrets!
 \RpgShowSecrets{true} 
 \lorumIpsumOne

 \begin{RpgSecret}{}
     The players don't know it yet, but all this pseudo-latin text is a hint that devils are involved! 
 \end{RpgSecret}

  \lorumIpsumTwo{}

  \begin{RpgSecret}{Logos kykloforia, thelxis kai ethos, tyrannis kai epilysis. Aei thera plaka, kyrios meion egestas, anagkas proin eira kai thera.}

     This bit of text is noteworthy - it's been added in after the fact
 \end{RpgSecret}

  \lorumIpsumThree{}
\end{ExampleBlock}
\end{figure}

        \RpgMacro*{RpgSecret}{\param{\paramO m} }{
            A switchable environment associated with the switch \texttt{ShowSecrets}. When this key is true, the body of the environment is rendered; otherwise it is hidden. 
            }{
                \cmd{begin}\param{RpgSecret}[<opts>]\param{<player-text>}

                ~~~<GM-text>

                \cmd{end}{RpgSecret}
            }{
                If the \texttt{ShowSecrets} switch has been set to false, then the \texttt<player-text> is inserted as plain text with nothing to suggest there's additional text being withheld.

                If the switch is true, then the GM text is rendered in a highlighted box, informing the reader that this information is considered secret. If player text was present, this is also shown, and highlighted as the 'publicly available' knowledge.

                The optional arguments take the form of key value pairs:
                \begin{RpgTable}{llX}
                    Key & Values & Effect
                    \\
                    \kve{title-secret}{string}{Sets the name above the `secret' text (if shown). Default value `Secret Text' }
                    \kve{title-public}{string}{Sets the name above the `player' text (if secret text is shown, and player text present). Default value is `Normal Text'}
                    \kve{color}{color specifier}{Sets the outline color of the `secret box' rendered when the key is set to true.}
                \end{RpgTable}
            }
        {\color{red}
        \RpgMacro{RpgShowSecrets}{\param{m}}{An alias for \cmd{RpgSetSwitch\param{ShowSecrets}\param{input}}}{}{}
        }


        
    \labelsection{RpgItem}
        \blindtext
    \labelsection{RpgAbility}
        \Blindtext
        \Blindtext
