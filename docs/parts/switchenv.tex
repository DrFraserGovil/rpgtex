\chapter{Switchable Environments}\label{S:SwitchEnv}

    Often it is convenient to be able to toggle between two different environments depending on an external flag. In the context of an RPG this might be for a number of reasons: having a player version and a GM version, or having a screen-readable version versus a printable one. 

    Whilst it is obviously possible to build an environment which performs the switching for you, we provide a generic interface for switching between \textit{similar environments}.

    \begin{RpgSidebar}{'Similar' Environments}
        It is important to note that this system only works for switching between environments which are `similar', insofar as they permit the same number and order of arguments, and interpret their contents similarly.

        An itemize and an enumerate are `similar': an itemize and a figure are not.
    \end{RpgSidebar}

    The overall goal of the RpgSwitchEnv is to reduce the amount of duplication that an author has to do to get the same text in multiple different forms. The system was originally designed for the \texttt{RpgCard} environment, to enable the same text to be written 'in the book' and 'on the card' with minimal duplication. 

    \labelsection{RpgSwitchEnv}
    \RpgMacro*{RpgSwitchEnv}{\param{m o m o m}}
        {
            Acts as one of two similar environments based on the value of an input key.
        }{
            \cmd{begin}\param{RpgSwitchEnv}\param{<key>}[opt-1]\param{env-1}[opt-2]\param{env-2}

            ~~<contents>

            \cmd{end}\param{RpgSwitchEnv}
        }{
            The \texttt{key} is an input token (a string) which should be in the global \textit{switch-registry} (see below). The value associated with that key determines the behaviour of the Switch-Env:
            \begin{description}
                \item[Value is true] The environment acts as \texttt{env-1} (with optional arguments \texttt{[opt-1]})
                \item[Value is false] The environment acts as \texttt{env-2[opt-2]}.
            \end{description}
            Due to the way that token expansion works, it is possible to pass \textit{additional} arguments to this environment:
            \begin{Code}
                \cmd{begin}\param{RpgSwitchEnv}\param{<key>}[opt-1]\param{env-1}[opt-2]\param{env-2}\param{arg1}\param{arg2}
            \end{Code}
            Formally speaking, \texttt{arg1} and \texttt{arg2} are a part of the body of the environment; however if both env-1 and env-2 are expecting two arguments, then the token expansion captures them. It is also possible to use a shared optional argument, instead of the unique arguments:
            \begin{Code}
                \cmd{begin}\param{RpgSwitchEnv}\param{<key>}\param{env-1}\param{env-2}[shared-opt]
            \end{Code}
            If however, the environments are not similar, and take different numbers of arguments then any excess arguments are inserted into the body of the environment, which can cause unexpected behaviour.

            An error is thrown if \texttt{key} does not exist in the global registry.
        }
        \RpgMacro{RpgSetSwitch}{\param{m m}}
            {Change the value of a \textit{switch}, and therefore the behaviour of the associated RpgSwitchEnv}{\cmd{RpgSetSwitch}\param{<key>}\param{<value>}}
            {
                Sets the value of the \texttt{key} in the \textit{switch-registry} to \texttt{{value}}, which must be a 'bool-ish' text string\footnote{That is, either \param{true,True,1} or \param{false,False,0}}. If the entry does not exist in the registry, it is created.

                After the key is set, all subsequent \texttt{RpgSwitchEnv} calls which use that key will have their behaviour altered to match the new key.
            }
        \RpgMacro{RpgSetAllSwitches}{\param{m}}
            {
                 As with \cmd{RpgSetSwitch}, but iterates over all keys in the registry, and assigns the all the same \texttt{value}.
            }{}{}
% \begin{figure}
\begin{ExampleBlock}[RpgSwitchEnv]{Example Switching Environment}
  \def\exampleSwitch{
      \begin{RpgSwitchEnv}{test}{enumerate} [leftmargin=1cm]{itemize}
        \item item 1
        \item item 2
        \item orangutans
      \end{RpgSwitchEnv}
  }
  Changing the switch makes the same contents appear differently:

  \RpgSetSwitch{test}{true}
  \exampleSwitch{}

  \RpgSetSwitch{test}{false}
  \exampleSwitch{}

  %%Now repeat, but move the optional arg to the end as a 'hanging argument' 

  \def\exampleSwitch{
      \begin{RpgSwitchEnv}{test}{enumerate} {itemize}[leftmargin=1cm]
        \item item 1
        \item item 2
        \item orangutans
      \end{RpgSwitchEnv}
  }
   Both environments should now be indented:
  \RpgSetSwitch{test}{true}
  \exampleSwitch{}

  \RpgSetSwitch{test}{false}
  \exampleSwitch{}
\end{ExampleBlock}
% \end{figure}


        



    \labelsection{RpgItem}
        
        Many RPGs have a system of `items' and equipment that a player may possess and use. It is useful to be able to both describe the item as it might appear in the source book, but also render it in a playing-card style unit \RpgPage[p]{S:Card} for a player to use. 

        The RpgCard is associated with the UseItemCard switch; when true the text is rendered in a card, when false, as plain text.

        \begin{RpgSidebar}{Highly Theme Dependent}
            This is documentation for the generic \texttt{RpgItem} interface for those wishing to customise their own.  It is expected that individual themes significantly extend the functionality. 
            
            Documentation for the specific implementations can be found elsewhere:
            \begin{description}
                \item[default:] \RpgPage{S:DefaultItem}
                \item[dnd:]	\RpgPage{S:DndItem}
                \item[scifi:]   \RpgPage{S:ScifiItem}
            \end{description} 
        \end{RpgSidebar}

        \RpgMacro*{RpgItem}{\param{\paramO{} m \paramO{}}}{A switchable environment associated with the UseItemCard switch. When true, places the contents in a \texttt{RpgCard} \RpgPage[p]{RpgCard}, when false, renders as plain text.}{
            \cmd{begin}\param{RpgItem}[<card-opts>]\param{<Item-name>}[<item-key/values>]
                
            ~~<item-body>

            \cmd{end}\param{RpgItem}
        }{
            The optional \texttt{card-opts} argument is passed to the \texttt{RpgCard} (if active), and controls the size and appearance of the card. The \texttt{item-name} is the name which will (generally) appear at the top of the item. 

            The \texttt{key/value} arguments are a kv-list of options. By default, only a single option is present:
            \begin{RpgTable}[noheader]{llX}
                \kve{image}{path/to/image}{Inserts the chosen image into the \textbf{card environment only}; between the item name and the body text.}
            \end{RpgTable}

            The customisation options (see below) allow a designer to add in additional keys, which they can then use to add a specific format to the item. Consult the individual theme documentation for implementation specific details.
        }
        
        \RpgMacro{RpgUseItemCards}{\param{m}}{An alias for \cmd{RpgSetSwitch\param{UseItemCard}\param{input}}}{}{}
        

\begin{ExampleBlock}{RpgItem}

 \def\testItem{
 \begin{RpgItem}[color=red, opacity=0.4] {Joyeuse} 
    [image=example/img/joyeuse]

    The legendary Sword of Charlemagne; this weapon is known as the `joybringer' and the `Jewelled Blade'. It grants you +13 on heroism rolls. 
 \end{RpgItem}}
 \RpgUseItemCards{false} %plain text first
\testItem{} 

 \RpgUseItemCards{true} %now the card
\testItem{} 
\end{ExampleBlock}

	\subsection{Customizing Items}

		We provide three key functions which allow a designer to completely change the appearance of an item card

		\RpgMacro{RpgAddItemProperty}{\param{m v m}}
			{}{
				\cmd{RpgAddItemProperty}\param{new-key}\param{\cmd{destination}}\param{default-value}
			}{Creates a new entry in the \texttt{rpg/item} key-value parser, which stores the value passed by the user in the chosen destination macro. If the key is not present in the RpgItem \texttt{key-value} argument, the default value is assigned instead.
			
			This allows a designer to request the user provide structured information, which they can then place as they choose.
			}
		
		\begin{RpgTip}{More Complex Key/Value behaviour}
			\cmd{RpgAddItemProperty} is a wrapper around the usual expl3 key interface, \cmd{keys\_define\param{rpg/item}}, automatically creating \cmd{tl\_set} commands (and a few others). For more complex key/value pairs, such as choices, toggles etc., a designer may manually edit the \texttt{rpg/item} registry.
		\end{RpgTip}
		\RpgMacro{RpgSetItemCardFormat}{\param{+m}}
			{A \COSS{}, with the resulting control sequence being used as the body of a \texttt{RpgCard} call when \cmd{RpgUseItemCards} has been set to true.}{
				\cmd{RpgSetItemCardFormat}\{
					\%\#1 = Card name, \#2 = Card body
				~~<card-description>

				\}
			}{
				As can be seen, the CoSS only takes two arguments; however by constructing a customised \cmd{RpgAddItemProperty} interface, the designer can add additional elements around the item body, and therefore have an arbitrary amount of information passed from the user -- see the examples below.
			}
		\RpgMacro{RpgSetItemTextFormat}{\param{+m}}	{A \COSS{}, with the resulting control sequence being used as the output of \texttt{RpgItem}, when \cmd{RpgUseItemCards} has been set to false.}
			{
				\cmd{RpgSetItemTextFormat}\{
					\%\#1 = Card name, \#2 = Card body
				~~<card-description>

				\}
			}{
				As can be seen, the CoSS only takes two arguments; however by constructing a customised \cmd{RpgAddItemProperty} interface, the designer can add additional elements around the item body, and therefore have an arbitrary amount of information passed from the user -- see the examples below.
			}
		

\begin{ExampleBlock}{Customised RpgItem}
 \RpgAddItemProperty{tagline} {\RpgItemTagline}{}
 \RpgAddItemProperty{weight} {\RpgItemWeight}{0kg}
 \RpgAddItemProperty{value} {\RpgItemValue}{\euro{}0}

 \def\testItem{
 \begin{RpgItem}[color=red, opacity=0.4] {Joyeuse} 
  [image=example/img/joyeuse,
  tagline={The Sword Jewellous},
  weight=1kg,
  value=\euro{}1 billion]
  The legendary Sword of Charlemagne; this weapon is known as the `joybringer' and the `Jewelled Blade'. It grants you +13 on heroism rolls. 
 \end{RpgItem}}

 %plain text first
 \RpgUseItemCards{false} 
 %%set the plaintext format
 \RpgSetItemTextFormat{
 \subsection{#1\hfill{}\RpgItemValue{}}
 \hrule{}
 \textit{\RpgItemTagline (\RpgItemWeight)}\par
 #2
 }
\testItem{} 

\vspace{1cm}

%now the card
 \RpgUseItemCards{true} 
 %%set the card format
 \RpgSetItemCardFormat{
  \begin{center}
    {\RpgFontSubsection #1}
    
      \includegraphics[width=0.8\linewidth, height=2cm]{\RpgItemImage}
    
    {\scshape \RpgItemTagline}
  \end{center}
 \vfill{}
 #2
 \vfill{}
 \RpgItemValue{} \hfill{} \RpgItemWeight{}
 }
\testItem{} 
\end{ExampleBlock}
    \labelsection{RpgAbility}
