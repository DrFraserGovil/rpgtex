\chapter{Environments}
\def\tcref{\forcelink{https://ctan.org/pkg/tcolorbox?lang=en}{tcolorbox}}


\labelsection{RpgCard}

    The RpgCard environment is designed to allow a writer to create a small, playing-card sized unit which is useful for handing out to players for game elements such as items, spells or abilities.

    The backend of the RpgCard is some of the most complex \LaTeX{} code in the package, but this makes it very powerful. We anticipate that users won't access RpgCard directly, but instead a wrapper such as RpgSpell \RpgPage[p]{S:RpgSpell Environment} -- however these serve only to format the text within the card environment in a specific way -- the Card itself remains flexible.

    The main power of the RpgCard is the ability to automatically \textit{cardbreak}, splitting large internal elements across multiple cards. 

    \subsection{The Environment}
        \RpgMacro*{RpgCard}{\param{\paramO}}{Splits the contents across a number of playing-card sized units}{
            
                \cmd{begin}\param{RpgCard}[<key-value-opts>]

                ~~~~~~<contents>

                \cmd{end}\param{RpgCard}
            }{
                Creates a card environment with a height and width defined either by \texttt{<opts>}, or the global variables. Text is automatically broken if it exceeds this height, creating multiple cards to hold the text.

				The available options are:
				\newcommand\kve[3]{\texttt{#1} & #2 & #3\\}
				\begin{RpgTable}{llX}
					Key & Values & Effect
					\\
					\kve{width}{dimexpr}{The outer width of the RPG card}
					\kve{hmargin}{dimexpr}{The horizontal margin between the card boundary and the inner text}
					\kve{height}{dimexpr}{The outer height of the RPG card}
					\kve{vmargin}{dimexpr}{The vertical margin between the card boundary and the inner text}
					\kve{cardsep}{dimexpr}{The horizontal space inserted after a card is finished}
					\kve{color}{color specifier}{The background color of the image. Replaces \textit{tcb/colback}}
					\kve{opacity}{[0-1]}{The opacity of the background of the image. Replaces \textit{tcb/opacityback}}
					\kve{under-img}{img/path}{An image to be used as the background of the card. Clipped to the card background so no overspill occurs.}
					\kve{underlay}{img/path}{An alias for under-img, which replaces \textit{tcb/underlay} to prevent premature tikz expansion.}
				\end{RpgTable}

				The formatting of RpgCard otherwise follows that of a \tcref{}, and all other tcb options can be passed in as normal. However, since the title-frame causes issues with the height calculations, RpgCards cannot use the tcb title interface: any attempt to set a title will fail. We provide two aliases, \texttt{color} and \texttt{opacity}, to make setting the usual values, \texttt{colback} and \texttt{opacityback}, less verbose and obtuse.

                Options passed to the environment take precedence to the global variables.

			

				}
				\begin{figure}
				\begin{center}
					\begin{tikzpicture}
			
						\node[anchor=south west,inner sep=0pt,outer sep=0pt] at (0,0) {
			
						\begin{RpgCard}[hmargin=0.5cm,vmargin=0.5cm]
	
							\noindent\ignorespaces\footnotesize 
	
							top left \hfill top right
	
							
							\vfill
							\tiny \lipsum[1]
	
							\vfill
							
							bottom left \hfill bottom right
	
						\end{RpgCard}\ignorespaces
						};
						\fill[white,opacity=0.6] (0,0) rectangle (5.35,8.8);
						% \draw(0.5,0.5) rectangle (4.85,8.3);
						% \draw[red,<->,thick] (0.7,0.5)-- node[right,rotate=90,anchor=north]{text height}++(0,7.8cm);
						\draw[red,<->,thick] (0.7,0)-- node[fill=white,right,rotate=90,anchor=north]{height}++(0,8.8cm);
						\draw[red,<->,thick] (1.4,0)-- node[right]{vmargin}++(0,0.5cm);
						\draw[red,<->,thick] (1.4,8.3)-- node[right]{vmargin}++(0,0.5cm);
	
						\draw[green!70!black,<->,thick] (0.5,2)--node[below]{width}++(4.35,0);
						\draw[green!70!black,<->,thick] (0,2.4)--node[below,rotate=90,anchor=east]{hmargin}++(0.5,0);
						\draw[green!70!black,<->,thick] (4.85,2.4)--node[below,rotate=90,anchor=east]{hmargin}++(0.5,0);
					\end{tikzpicture}
				\end{center}
				\caption{The dimensions of an RpgCard}
			\end{figure}
                
    \subsection{Helper Commands}
		
		\RpgMacro{RpgSetCard}{\param{m}}{Sets the card parameters as global values for all subsequent cards}
		{
			\cmd{RpgSetCard}\param{<key/values>}
		}
		{
			The \texttt{<opts>} can contain any of the valid inputs to the \texttt{RpgCard} environment: this acts to set them as global default values, but any locally set values will override them.
		}

		\RpgMacro{RpgResetCard}{\param{}}{Resets changes made to card parameters back to the defalt value.}{}{}
		% \RpgMacro{}
\newpage
		\RpgMacro{cardbreak}{\param{}}{Analogous to \cmd{pagebreak}, forces a card to break at the specified location.}
		{
			<before-text>

			\cmd{cardbreak}
			
			<after-text>
		}
		{
			The command inserts an infinite, but hidden, vertical space penalty, causing the card to break at its location, as if it had been `filled up'.

			\cmd{cardbreak} is any empty function outside of the \texttt{RpgCard} environment, so it will have no effect on RpgCardSwitch environments.
		}
    \subsection{Examples}

 \begin{ExampleBlock}[RpgCard,footnote]{Simple RpgCard}
 \begin{RpgCard}
 \subsubsection{Text goes here}
                 It fits nicely into the card, wrapping over lines\footnote{We can also have a single footnote}.
 \end{RpgCard}
 \end{ExampleBlock}

 \begin{ExampleBlock}[RpgCard,footnote]{Large RpgCard}
 \begin{RpgCard}
 {And if we add lots of text\footnote{Normally RpgCards stack side-by-side before breaking over lines -- here they've not got enough room, so it's vertically stacked.}}
                 
 \blindtext
 \end{RpgCard}
 \end{ExampleBlock}


\labelsection{RpgMap}

    The RpgMap environment makes it easy to create nested blocks, useful when needing to enumerate the contents of a map. The RpgMap environment uses a stacked counter system and dynamic labelling.

    \RpgMacro*{RpgMap}{RpgMap*, \param{{o}}}{Begins a dynamic-stacked environment for generating headed and labelled lists using the \cmd{RpgArea} object to provide entries. }{
        \bs{}begin\param{RpgMap}[<opts>]

        ~~~<contents>

        \cmd{end}\param{RpgMap}				
    }{
        The starred version of the command is identical in function, but calls \cmd{section*} instead of \cmd{section} (and so on.), suppressing the map elements from the table of contents. 
        
        RpgMap uses the counter \texttt{RpgAreaDepth} to track how many Maps have been nested. A higher value of this counter results in `smaller' headings being used, beginning with \cmd{section} and progressing to \cmd{subparagraph}.

        The permitted options are:
        \newcommand\mapopt[2]{\texttt{#1} &#2\\}
        \begin{RpgTable}{lX}
            Option & Effects \\
            \mapopt{header-offset}{An offset added to RpgAreaDepth when determing the heading size to be used (an offset of 0 uses \cmd{section} for the top level map entires, an offset of 1 uses \cmd{subsection}, and so on).}
            \mapopt{title}{If non-empty, places the contents in a section one size larger than \texttt{RpgAreaDepth+header-offset} (using \cmd{chapter} for the largest possible size). The title is only rendered at the top-level of the map (if RpgAreaDepth=1), otherwise it is ignored. Default value is blank.}
            \mapopt{prefix}{A string which is automatically prefixed to the 'number string' of named \cmd{RpgArea} entries in the map. Default is blank.}
            \mapopt{blank-prefix}{A string which is automatically prefixed to the `number string' of unnamed (blank) \cmd{RpgArea} entries in the map. Default is ``\texttt{Area~}''}
            \mapopt{ref-prefix}{A string prefixed to all labels created by \cmd{RpgArea}, allowing disambiguation of references. Default is ``\texttt{Map:}''}
        \end{RpgTable}

        The variables set by options are persistent throughout the nesting - setting \texttt{ref-prefix} in one map will mean the same value persists in all encapsulated maps unless manually overridden. Changes do \textit{not} persist once the nesting is finished.

    }
    \RpgMacro{RpgArea}{\param{{o m}}}{
            Creates a formatted entry within the RpgMap environment. The appearance of the title depends on the map-depth and the current header-offset.
        }{
            \bs{}RpgArea[<manual-label>]\param{<area-name>}
        }{
            Creates a `header' depending on the value of \texttt{RpgCounter + headeroffset}:
            \begin{enumerate}
                \item section
                \item subsection
                \item subsubsection
                \item paragraph
            \end{enumerate}
            If outside these values, uses \texttt{subparagraph}. The name of the section is preceeded by the `map counter', which is equal to the index within the current map, appended to the `map counter' of any parent maps. The formatting function \texttt{RpgMapLevelName} enables hierarchical labelling, such that the third area inside the second map of the first map would be given the counter value `1b-iii'.

            If the manual label is set, this is used as the label for this area; otherwise the automatic labelling is used (see below).
    }
    \RpgMacro*{RpgNestedArea}{{{o o m}}}
        {
            A wrapper environment for calling \cmd{RpgArea} and then immediately \cmd{begin\param{RpgMap}}, creating nested map areas in a single call.
        }
        {
            \cmd{begin}\param{RpgNestedArea}[manual-label][<nested-opts>]\param{<area name>}

            ~~~\ldots

            \cmd{end}\param{RpgNestedArea}
        }{
            Note that since the RpgMap environment is invoked after the RpgArea is created, the options passed to \texttt{<nested-opts>} do not apply to the parent Area, which uses the Map options of its own parent.
        }
                
 \begin{figure*}
 \begin{ExampleBlock}[RpgMap,RpgArea,RpgNestedArea]{Example RpgMap}
 \begin{RpgMap*}[
  header-offset=1,%start at subsection
  title={Example Map}]
  
  \RpgArea{The Spooky Mansion} 
     There are things here
  
  \begin{RpgMap}[
     title={ignored-as-nested}
     ]
     \RpgArea{Entrance Hall}
         Where you go to enter
     \RpgArea{Kitchen}
         Yum, food
  \end{RpgMap}
  
  \begin{RpgNestedArea}[][header-offset=2]
     {The Creepy Grounds}
     We set a header-offset for this nested block, so....
     \RpgArea{The gardens}
         Note that this is a paragraph, not a subsection
     \begin{RpgNestedArea}{The stables}
         Horses live(d) here.
     
         \RpgArea{Shire horse}
             A very big boi, which still keeps the parent's header-offset
 
         \RpgArea{Shetland pony}
             And a tiny one too!
     \end{RpgNestedArea}
  \end{RpgNestedArea}
  
  \RpgArea{The Graveyard}
     The additional offset-didn't persist; we're back to subsections again, and the next element will be a subsubsection.
 
     \begin{RpgMap}[
         blank-prefix={Tomb~}
         ]
         \RpgArea{}
             This is an unnamed area - it gets given a slightly different name
         \RpgArea[tomb-ref]{}
             I might want to refer to this later, even though it is unnamed.
     \end{RpgMap}
 \end{RpgMap*}
 \end{ExampleBlock}
 \end{figure*}
 

    \subsection{Map Labelling \& Referencing}
                    
        Each RpgArea with a non-empty name automatically labels itself using the syntax	\texttt{ \bs{}label{<ref-prefix><area-name>}}. If a manual label was passed to the RpgArea, this is used instead (without the prefix), even if the RpgArea was not named. This is designed to provide disambiguation, as no automatic checks are performed for name collisions. 

        It is then possible to call \cmd{ref} on this label\footnote{Though it won't give you anything interesting -- the returned value will be the cumulative number of RpgAreas in the document at that point} and \cmd{pageref} or \cmd{RpgPage} \RpgPage[p]{Macro:RpgPage}. However, we provide a more powerful referencing interface:

        \RpgMacro{RpgMapRef}{\cmd{RpgMapRef*},\param{{m}}}{Returns the full name of the referenced area, including the map counter. The starred version returns only the map counter.}
            {
                \bs{}RpgMapRef\param{<label-name>}
            }
            {
                The provided text is fully integrated with \texttt{hyerref}, and so they enable click-jumping to the referenced map area. 
                
                Using the example map provided above:
                \begin{RpgTable}{XX}
                    Example & Output \\
                    \tabverbExample{\RpgMapRef{Map:Shire horse}}
                    \tabverbExample{\RpgMapRef*{Map:Shire horse}}
                    \tabverbExample{\RpgMapRef*{tomb-ref}}
                \end{RpgTable}
            }
        \RpgMacro{RpgMapRefPage}{\cmd{RpgMapRefPage*},\param{{m}}}{Appends the page number of the referenced map area to a \cmd{RpgMapRef(*)} command}
            {
                \bs{}RpgMapRefPage\param{<label-name>}
            }
            {
                Using the example map provided above:
                \begin{RpgTable}{XX}
                    Example & Output \\
                    \tabverbExample{\RpgMapRefPage{Map:Shire horse}}
                    \tabverbExample{\RpgMapRefPage*{Map:Shire horse}}
                    \tabverbExample{\RpgMapRefPage*{tomb-ref}}
                \end{RpgTable}
            }
        \RpgMacro{RpgShowMapRefs}{}{If called, all subsequent \cmd{RpgArea}s will print out a sub-heading listing their macro name.}
        {}
        {
            It is not unheard of for a writer to lose track of the labelling name conventions - especially those which are autogenerated. This provides a useful debugging tool for those who don't want to go digging into the aux files.				
        }

                                                

 \begin{ExampleBlock}[RpgShowMapRefs,tomb-ref]{Example RpgMap with labelling.}
 
  \RpgShowMapRefs{}
  \begin{RpgMap*}[
      header-offset=1,
      title={Example Map}
   ]
   
   \RpgArea{The Spooky Mansion} 
      (\dots)%(skip for example!)    
      \RpgArea{The Graveyard}
          (\dots)%(skip for example!)
          \begin{RpgMap}[
                  blank-prefix={Tomb~}
              ]
              \RpgArea{}
              Unlabelled area.
              \RpgArea[tomb-ref]{}
                  (\dots)%(skip for example!)
          \end{RpgMap}
  \end{RpgMap*}
 \end{ExampleBlock}


\labelsection{RpgTable}

    \RpgMacro*{RpgTable}{\param{o m}}{Begins an environment for creating visually appealing and consistent tables. }{
        \cmd{begin}\param{RpgTable}[<options>]\param{<column-specifications}

        ~~~~{<table-contents>}

        \cmd{end\param{RpgTable}}
    }{
        RpgTable is a wrapper for the \forcelink{https://ctan.org/pkg/tabularx}{tabularx} (or \forcelink{https://ctan.org/pkg/xltabular}{xltabular} -- see \texttt{breakable}) environment, and so accepts the standard set of column specifications:\{c,l,r,p{width},\@,\ldots{}\} and the extended set (i.e. X). It therefore acts almost identically to the standard tabular environment with a few stylistic differences.
        \subsection{Stylistic Changes}
            The RpgTable environment makes the following changes:
            \begin{enumerate}
                \item \textbf{Title.} If the \texttt{title} option is set, a title-heading is rendered above the tablular in the font \cmd{RpgFontTableTitle}.
                \item \textbf{Auto-headings.} The first row of the tabular environment is automatically rendered in the font \cmd{RpgFontTableHeader}, allowing for trivial header labels.
                \item \textbf{Font Integration.} The main body of the table is rendered in \cmd{RpgFontTableBody}.
                \item \textbf{Auto-colouring.} The rows alternate between being transparent and being set to the \texttt{tablecolor} variable \RpgPage[p]{S:Colors}. This is powered by \texttt{rowcolors}.
            \end{enumerate}
        \subsection{Optional Arguments}
        \begin{description}
            \item[width=<dimexpr>] Fixes the width of the tabular environment to the value of this argument. Default value is the current \texttt{\bs{}linewidth}.
            \item[color=<color-name>] If set, uses this value instead of \texttt{tablecolor} for the alternating coloration.
            \item[title=<text>] Sets the text to be rendered as the title of the table. 
            \item[breakable] If flag is present, renders using \texttt{xltabular}, enabling the table to break over pages. \textbf{only available in 1-column mode (a fundamental limitation of xltabular).}
            \item[noheader] If flag is present, suppresses the autoformatting of the title. The first row is instead rendered in the body formatting.
        \end{description}
    }
    \subsection{RpgTable Example}


        This is the standard usage of the table, showing automatic formatting of the header rows and the word-wrapping abilities of the X-column:
 \begin{ExampleBlock}{Standard RpgTable}
 \begin{RpgTable}[width=0.75\linewidth, color=green!30!white]{lX}
 Header 1 & Header 2
 \\
 Text & Some text which fills up the space to 75\% of the line width then breaks
 \\
 Alternating & This row is transparent
 \\
 Colour & but this one is the colour we set in the header
 \end{RpgTable}
 \end{ExampleBlock}
 This example adds a title, but suppresses the header formatting:
 \begin{ExampleBlock}{Header-Suppressed RpgTable}
 \begin{RpgTable}[title={Test Table},noheader]{XlX}
 Plain & Header & Text
 \\
 Now there's no & difference & between the header and the main
 \\
 body
 \end{RpgTable}
 \end{ExampleBlock}

\labelsection{Text Boxes}

    \rpgtex{} defines three `colorbox' environments, which inherit from \tcref{}. These provide a consistent way for a writer to highlight and differentiate blocks of text on the page.

    \begin{RpgSidebar}{Which colorbox to use?}
        
        The choice between RpgSidebar and RpgTip is somewhat arbitrary -- although they have a mechanical difference by default (one being breakable, the other not) -- this can be overridden by themes. Instead, the intention is that they serve slightly different purposes:
        
        \begin{description}
                        \item[RpgSidebar] is used for `important information' -- key rules or summaries which readers \textit{should} pay attention to.
                        \item[RpgTip] is for `helpful additions' -- tips, tricks and trivia that are not necessary, but which might be useful, and are too big to fit into a footnote or parenthetical.   
        \end{description}
    \end{RpgSidebar}

    All of the boxes inherit the standard `tcb' style interface, and so tcolorbox options may be passed by the user to control their appearance.

    \RpgMacro*{RpgNarration}{\param{{o}}}{A \tcref{} wrapper designed for text that is read aloud to players}
        {
            \texttt{\bs{}begin\param{RpgNarration}[color=<color>,<tcbox-options>]}

            ~~~~\texttt{<text>}
            
            \cmd{end\param{RpgNarration}}
        }{
            RpgNarration does not (by default) set a title, using only `body text', which is typeset using the \texttt{RpgFontNarration} font. The optional \texttt{<tcbox-options>} argument can be a list of all the basic tcolorbox options (see that documentation). The \texttt{color} argument is an alias for \texttt{colback} (\texttt{colbacktitle} is also set, but is ignored as the title is empty). Due to the order of processing, if both \texttt{color} and \texttt{colback} are set, the value of \texttt{colback} is used.

            Themes may alter the appearance of the narration block using the tcb interface, calling \texttt{\bs{}tcbset\param{rpgnarration /.append~style={...}}} to overwrite the existing instructions.
        }

   \begin{ExampleBlock}[RpgNarration]{RpgNarration}
    \begin{RpgNarration}[color=blue!30!white]
     This is text that you would read out loud to players, describing a scene. It will always be blue, even if the theme says otherwise -- because the optional argument takes priority.
    \end{RpgNarration}
   \end{ExampleBlock}

    \RpgMacro*{RpgSidebar}{\param{{o m}}}{A decorated \tcref{} wrapper designed for information which is set outside the main text.}
        {
            \cmd{begin\param{RpgSidebar}[color=<color>,<tcbox-options>]\param{<title>}}

            ~~~~{<text>}
            
            \cmd{end\param{RpgSidebar}}
        }{
            RpgSidebar requires a title (using \texttt{RpgFontSidebarTitle}) as well as the body text (\texttt{RpgFontSidebarBody}). 	RpgSidebar is typically more highly decorated than RpgTip, and does not have the \texttt{breakable} flag set. It is usually best to use one of the `float' options.
            
            The optional \texttt{<tcbox-options>} argument can be a list of all the basic tcolorbox options (see that documentation). The \texttt{color=x} argument is equivalent to calling both \texttt{colback=x} and \texttt{colbacktitle=x}. Due to the order of processing, if both \texttt{color} and \texttt{colback} are set, the value of \texttt{colback} is used.


            Themes may alter the appearance of the sidebar using the tcb interface, calling \texttt{\bs{}tcbset\param{rpgsidebar /.append~style={\ldots}}} to overwrite the existing instructions.
        }
    \begin{ExampleBlock}[RpgSidebar]{RpgSidebar}
    \begin{RpgSidebar}{A Sidebar}
     This is an important block of text, that you should pay attention to.
    \end{RpgSidebar}
   \end{ExampleBlock}
    \RpgMacro*{RpgTip}{\param{{o m}}}{A simple \tcref{} wrapper designed for information which is set outside the main text.}
        {
            \cmd{begin\param{RpgTip}[color=<color>,<tcbox-options>]\param{<title>}}

            ~~~~\texttt{<text>}
            
            \cmd{end\param{RpgTip}}
        }{
            RpgTip is similar to RpgSidebar, requiring a title (\texttt{RpgFontTipTitle}) in addition to the body text (\texttt{RpgFontTipBody}). However, it is generally simpler, enabling it to safely break over page boundaries. The optional \texttt{<tcbox-options>} argument can be a list of all the basic tcolorbox options (see that documentation). The \texttt{color=x} argument is equivalent to calling both \texttt{colback=x} and \texttt{colbacktitle=x}. Due to the order of processing, if both \texttt{color} and \texttt{colback} are set, the value of \texttt{colback} is used.

            Themes may alter the appearance of the narration block using the tcb interface, calling \texttt{\bs{}tcbset\param{rpgnarration /.append~style={...}}} to overwrite the existing instructions.
    }

    

    \begin{ExampleBlock}[RpgTip]{RpgTip}
    \begin{RpgTip}{A Tip}
     This is some helpful - but not vital - text.
    \end{RpgTip}
    \end{ExampleBlock}


