\chapter{Environments}
\def\tcref{\forcelink{https://ctan.org/pkg/tcolorbox?lang=en}{tcolorbox}}

\labelsection{RpgCards}\label{S:Card}

    The RpgCard environment is designed to allow a writer to create a small, playing-card sized unit which is useful for handing out to players for game elements such as items, spells or abilities.

    We anticipate that users won't access RpgCard directly, but will instead access it through wrappers which utilise the RpgSwitchEnv protocol \RpgPage[p]{RpgSwitchEnv} to allow items to be typeset `normally', and in card-mode. 

    The main power of the RpgCard is the ability to automatically \textit{cardbreak}, splitting large internal elements across multiple cards. 

    \RpgMacro*{RpgCard}{\param{\paramO}}{Splits the contents across a number of playing-card sized units}{
        
            \cmd{begin}\param{RpgCard}[<key-value-opts>]

            ~~~~~~<contents>

            \cmd{end}\param{RpgCard}
        }{
            Creates a card environment with a height and width defined either by \texttt{<opts>}, or the global variables. Text is automatically broken if it exceeds this height, creating multiple cards to hold the text.

            The available options are:
            % \newcommand\kve[3]{\texttt{#1} & #2 & #3\\}
            \begin{RpgTable}{llX}
                Key & Values & Effect
                \\
                \kve{width}{dimexpr}{The outer width of the RPG card}
                \kve{hmargin}{dimexpr}{The horizontal margin between the card boundary and the inner text}
                \kve{height}{dimexpr}{The outer height of the RPG card}
                \kve{vmargin}{dimexpr}{The vertical margin between the card boundary and the inner text}
                \kve{cardsep}{dimexpr}{The horizontal space inserted after a card is finished}
                \kve{color}{color specifier}{The background color of the image. Replaces \textit{tcb/colback}}
                \kve{opacity}{[0-1]}{The opacity of the background of the image. Replaces \textit{tcb/opacityback}}
                \kve{under-img}{img/path}{An image to be used as the background of the card. Clipped to the card background so no overspill occurs.}
                \kve{underlay}{img/path}{An alias for under-img, which replaces \textit{tcb/underlay} to prevent premature tikz expansion.}
            \end{RpgTable}

            The formatting of RpgCard otherwise follows that of a \tcref{}, and all other tcb options can be passed in as normal. However, since the title-frame causes issues with the height calculations, RpgCards cannot use the tcb title interface: any attempt to set a title will fail. We provide two aliases, \texttt{color} and \texttt{opacity}, to make setting the usual values, \texttt{colback} and \texttt{opacityback}, less verbose and obtuse.

            Options passed to the environment take precedence to the global variables.

            Note that the RpgCard also temporarily redefines the \cmd{footnote} command (see \cmd{footnote} below).

            }
            
    \RpgMacro{cardbreak}{\param{}}{Analogous to \cmd{pagebreak}, forces a card to break at the specified location.}
        {
            <before-text>

            \cmd{cardbreak}
            
            <after-text>
        }
        {
            The command inserts an infinite, but hidden, vertical space penalty, causing the card to break at its location, as if it had been `filled up'.

            \cmd{cardbreak} is any empty function outside of the \texttt{RpgCard} environment, so it will have no effect on RpgCardSwitch environments.
        }
    \RpgMacro{footnote}{\param{m}}{A redefinition of the standard footnote to account for the quirks of an RpgCard}
        {
            <before-text>\cmd{footnote}\param{foottext}<after-text>
        }
        {
            Due to the multiple processing passes required to ensure that the RpgCard contents fit inside the relevant space, and since footnotes must fit within that space, we had a great deal of difficulty getting footnotes to work as expected (despite them nominally functioning in a tcolorbox).

            The compromise is that \textbf{only a single footnote can appear in a card}, and the standard \cmd{footnote} command is redefined for the duration of the environment. If multiple footnotes are present, only the final one (in order of execution) will appear. The footnote appears at the bottom of the final card, separated from the main text by a \cmd{hrule}. 

            An RpgCard-footnote does not increment the global footnote counter.
        }
    \RpgMacro[RpgCard!Set]{RpgCardSet}{\param{m}}{Sets the card parameters as global values for all subsequent cards}
        {
            \cmd{RpgCardSet}\param{<key/values>}
        }
        {
            The \texttt{<opts>} can contain any of the valid inputs to the \texttt{RpgCard} environment: this acts to set them as global default values, but any locally set values will override them.
        }

    \RpgMacro[RpgCard!Reset]{RpgCard!Reset}{\param{}}{Resets changes made to card parameters back to the defalt value.}{}{}
    
    \colorlet{ForestGreen}{green!70!black}
\begin{figure}
  \begin{ExampleBlock}[RpgCard,footnote]{Simple RpgCard}
 
 \begin{tikzpicture}%wrap in tikz so we can draw dimensions
  
    \node[anchor=south west,inner sep=0pt,outer sep=0pt] at (0,0) 
    {
    \begin{RpgCard}[hmargin=0.5cm,vmargin=0.5cm]
  
      \subsubsection{Text goes here}
        It fits nicely into the card, wrapping over lines\footnote{We can also have a single footnote}.
    \end{RpgCard}\ignorespaces
    };
    %% Draw the dimenions on top
    %height and vmargin
    \draw[red,<->] (0.7,0)-- node [fill=white, right, rotate=90, anchor=north]{height}++(0,8.8cm);
    \draw[red,<->] (1.4,0)-- node [right]{vmargin}++(0,0.5cm);
    \draw[red,<->] (1.4,8.3)-- node [right]{vmargin}++(0,0.5cm);
    %width and hmargin
    \draw[ForestGreen,<->] (0.5,2)-- node[below]{width}++(4.35,0);
    \draw[ForestGreen,<->] (0,2.4)-- node[below, rotate=90, anchor=east]{hmargin}++(0.5,0);
    \draw[ForestGreen,<->] (4.85,2.4)-- node[below, rotate=90, anchor=east]{hmargin}++(0.5,0);
  \end{tikzpicture}
  \end{ExampleBlock}
  \caption{An example of a simple RpgCard with the dimensions overlayed}
\end{figure}

\begin{figure}[H]
 \begin{ExampleBlock}[RpgCard,footnote]{Large RpgCard}
 \begin{RpgCard}
 {And if we add lots of text\footnote{Normally RpgCards stack side-by-side before breaking over lines -- here they've not got enough room, so it's vertically stacked.}}
                 
 \blindtext
 \end{RpgCard}
 \end{ExampleBlock}
 \caption{An example of an RpgCard with the automatic cardbreaking.}
\end{figure}


\labelsection{RpgMap}

    The RpgMap environment is similar to the standard itemize/ description/ enumerate environments, providing a structured way to list elements in an arbitrarily nested fashion. The main difference from the standard list environments are that \texttt{RpgMap} (and \cmd{area}, the analogue to \cmd{item}) provide a more elaborate labelling system, useful when needing to enumerate the contents of a map. 

    \RpgMacro*{RpgMap}{RpgMap*, \param{{o}}}{Begins a nestable map-list environment and enables the \cmd{area} command for adding entries to the map.}{
        \bs{}begin\param{RpgMap}[<opts>]

        ~~~<contents>

        \cmd{end}\param{RpgMap}				
    }{
        The starred version of the command is identical in function, with the exception that \cmd{area} calls \cmd{section*} instead of \cmd{section} (and so on.), suppressing the map elements from the table of contents. 
        
        RpgMap uses the counter \texttt{RpgAreaDepth} to track how many Maps have been nested. A higher value of this counter results in `smaller' headings being used, beginning with \cmd{section} and progressing to \cmd{subparagraph}.

        The permitted options are:
        \newcommand\mapopt[2]{\texttt{#1} &#2\\}
        \begin{RpgTable}{lX}
            Option & Effects \\
            \mapopt{header-offset}{An offset added to RpgAreaDepth when determing the heading size to be used (an offset of 0 uses \cmd{section} for the top level map entires, an offset of 1 uses \cmd{subsection}, and so on).}
            \mapopt{title}{If non-empty, places the contents in a section one size larger than \texttt{RpgAreaDepth+header-offset} (using \cmd{chapter} for the largest possible size). The title is only rendered at the top-level of the map (if RpgAreaDepth=1), otherwise it is ignored. Default value is blank.}
            \mapopt{prefix}{A string which is automatically prefixed to the 'number string' of named \cmd{RpgArea} entries in the map. Default is blank.}
            \mapopt{blank-prefix}{A string which is automatically prefixed to the `number string' of unnamed (blank) \cmd{RpgArea} entries in the map. Default is ``\texttt{Area~}''}
            \mapopt{ref-prefix}{A string prefixed to all labels created by \cmd{RpgArea}, allowing disambiguation of references. Default is ``\texttt{Map:}''}
        \end{RpgTable}

        The variables set by options are persistent throughout the nesting - setting \texttt{ref-prefix} in one map will mean the same value persists in all encapsulated maps unless manually overridden. Changes do \textit{not} persist once the nesting is finished.

    }
    \RpgMacro[RpgMap!area]{area}{area, \param{\paramO \paramO}}
        {Adds an area entry into the current RpgMap. The appearance of the entry depends on the current map depth.\index{area|see {RpgMap, area}} }
        {
              \cmd{area}[area-name][<manual-label>]

            ~

            Or

            ~

             \cmd{begin}\param{area}[area-name][manual-label]

            ~~~\ldots <nested-contents>

            \cmd{end}\param{area}
        }{
            Can be called either as a command (\cmd{area}), or as an environment (\cmd{begin\param{area}}), with slightly differing behaviours.

            \subsection{As a Command}
                 \begin{RpgTip}{Design Intent}
                    When called as a command, \cmd{area} is designed to act similarly to an \cmd{item} call inside a \texttt{description} environment, providing a familiar interface.
                \end{RpgTip}
                Inserts a `header block' with the following properties:
                \begin{enumerate}
                    \item Block is wrapped in a \cmd{chapter},\cmd{section}, \cmd{subsection} (etc.) depending on the number of nested \texttt{RpgMap} environments and the \texttt{header-offset}.
                    \item The header text is one of the following:
                    \begin{enumerate}
                        \item \texttt{<prefix> <counter>. <area-name>} if the first optional argument is a non-empty string.
                        \item \texttt{<blank-prefix> <counter>} if an \texttt{area-name} was not provided.
                    \end{enumerate}
                    \texttt{prefix} and \texttt{blank-prefix} are arguments passed to the parent RpgMap.
                    \item The heading is automatically labelled using the following syntax:
                    \begin{enumerate}
                        \item If a \texttt{manual-label} argument was provided, this is used as the label; \cmd{label\param{manual-label}}.
                        \item If none was provided, and \texttt{area-name} is non-empty, then the label is set as \cmd{label\param{<ref-prefix><area-name}}.
                        \texttt{ref-prefix} is a property of the parent RpgMap, with the default value being \texttt{Map:}.
                    \end{enumerate}
                    \item Text following the \cmd{area} is rendered as normal text with no modifications.
                \end{enumerate} 
               
            \subsection{As an Environment}

                Fig. \ref{F:MapNesting} shows that is possible to nest maps within an \cmd{area} by first adding an area, and then creating a map. We also provide an interface to do this automatically, if \texttt{area} is called as an environment.

                The syntax and arguments remain identical to the command version, but the body of an \texttt{area} environment acts as if it was wrapped in a nested \texttt{RpgMap} call.
                
                The following blocks of code are therefore identical in functionality:
                
                \begin{minipage}[t]{0.48\linewidth}
                \begin{Code}
                    \cmd{begin}\param{area}[name][label] 

                    ~<map-contents>

                    \cmd{end}\param{area}
                \end{Code}
                \end{minipage}\hspace{0.04\linewidth}\begin{minipage}[t]{0.48\linewidth}
                \begin{Code}
                    \cmd{area}[name][label]

                    \cmd{begin}\param{RpgMap}
                    
                    ~<map-contents>

                    \cmd{end}\param{RpgMap}
                \end{Code}
                \end{minipage}

                This is demonstrated in Fig. \ref{F:MapAreaNesting}. 

                It is not possible to pass additional options to the internal \texttt{RpgMap} call when using the area environment; if the user wishes to vary the commands at different depths, they must use an explicit \texttt{RpgMap} environment. 
        }
        \begin{figure}[t]
        \begin{ExampleBlock}[RpgMap,area]{RpgMap with manual nesting}
\begin{RpgMap}
    \area[Test Zone]
    A description
    \begin{RpgMap}
        \area[Sub Zone]
        A sub-description
        \begin{RpgMap}
            \area[Arbitrary nested zone]
            (we can keep nesting)
        \end{RpgMap}
    \end{RpgMap}
    \area A nameless zone
\end{RpgMap}
        \end{ExampleBlock}\
        \caption{An example of RpgMap with area-nesting}\label{F:MapNesting}
        \end{figure}

         \begin{figure}[!b]
        \begin{ExampleBlock}[area,RpgMap]{RpgMap with manual nesting}
\begin{RpgMap}
    \begin{area}[Test Zone]
    A description
        \begin{area}[Sub Zone]
            A sub-description
            \area[Arbitrary nested zone]
                (we can keep nesting)
        \end{area}
    \end{area}
    \area[][nameless-ref] A nameless zone
\end{RpgMap}
        \end{ExampleBlock}\
        \caption{An example of RpgMap with area-nesting}\label{F:MapAreaNesting}
        \end{figure}

    \subsection{Map Labelling \& Referencing}
                    
        Each \texttt{area} with a non-empty name automatically labels itself using the syntax	\texttt{ \bs{}label\param{<ref-prefix><area-name>}}. If a manual label was passed to the area, this is used instead (without the prefix), even if the area was not named. This is designed to provide disambiguation, as no automatic checks are performed for name collisions. 

        It is then possible to call \cmd{ref} on this label\footnote{Though it won't give you anything interesting -- the returned value will be the cumulative number of areas in the document at that point} and \cmd{pageref} or \cmd{RpgPage} \RpgPage[p]{Macro:RpgPage}. However, we provide a more powerful referencing interface:

    \RpgMacro[RpgMap!Ref]{RpgMapRef}{\cmd{RpgMapRef*},\param{{m}}}{Returns the full name of the referenced area, including the customised map counter. The starred version returns only the map counter.}
            {
                \bs{}RpgMapRef\param{<label-name>}
            }
            {
                The provided text is fully integrated with \texttt{hyperref}, and so they enable click-jumping to the referenced map area. 
                
                Using the example map provided above:
                \begin{RpgTable}{XX}
                    Example & Output \\
                    \tabverbExample{\RpgMapRef{Map:Test Zone}}
                    \tabverbExample{\RpgMapRef*{Map:Sub Zone}}
                    \tabverbExample{\RpgMapRef{nameless-ref}}
                \end{RpgTable}
            }
        \RpgMacro[RpgMap!RefPage]{RpgMapRefPage}{\cmd{RpgMapRefPage*},\param{{m}}}{Appends the page number of the referenced map area to a \cmd{RpgMapRef(*)} command}
            {
                \bs{}RpgMapRefPage\param{<label-name>}
            }
            {
                Using the example map provided above:
                 \begin{RpgTable}{XX}
                    Example & Output \\
                    \tabverbExample{\RpgMapRef{Map:Test Zone}}
                    \tabverbExample{\RpgMapRef*{Map:Sub Zone}}
                    \tabverbExample{\RpgMapRef{nameless-ref}}
                \end{RpgTable}
            }
        \RpgMacro[RpgMap!ShowRefs]{RpgMapShowRefs}{}{If called, all subsequent \cmd{area}s will print out a sub-heading listing their macro name.}
        {}
        {
            It is not unheard of for a writer to lose track of the labelling name conventions - especially those which are autogenerated. This provides a useful debugging tool for those who don't want to go digging into the aux files.				
        }

                                                

 \begin{ExampleBlock}[RpgMapShowRefs,tomb-ref]{Example RpgMap with labelling.}
 
  \RpgMapShowRefs{}
   \begin{RpgMap}
    \begin{area}[Test Zone]
    A description
        \begin{area}[Sub Zone]
            A sub-description
            \area[Arbitrary nested zone]
                (we can keep nesting)
        \end{area}
    \end{area}
    \area[][nameless-ref] A nameless zone
\end{RpgMap}
 \end{ExampleBlock}

    \labelsection{RpgSecret}

        The RpgSecret environment uses the RpgSwitchEnv system \RpgPage[p]{S:SwitchEnv} to conditionally hide information; this allows a Game Master\footnote{Or whatever your system calls this role!} to use the same text for their own notes as they would for players, but wall off some parts of it as 'not for their eyes'. 

    \RpgMacro*{RpgSecret}{\param{\paramO m} }{
        A switchable environment \RpgPage[p]{S:SwitchEnv} associated with the switch \texttt{ShowSecrets}. When this key is true, the body of the environment is rendered; otherwise it is hidden. 
        }{
            \cmd{begin}\param{RpgSecret}[<opts>]\param{<player-text>}

            ~~~<GM-text>

            \cmd{end}{RpgSecret}
        }{
            If the \texttt{ShowSecrets} switch has been set to false, then the \texttt<player-text> is inserted as plain text with nothing to suggest there's additional text being withheld.

            If the switch is true, then the GM text is rendered in a highlighted box, informing the reader that this information is considered secret. If player text was present, this is also shown, and highlighted as the 'publicly available' knowledge.

            The optional arguments take the form of key value pairs:
            \begin{RpgTable}{llX}
                Key & Values & Effect
                \\
                \kve{title-secret}{string}{Sets the name above the `secret' text (if shown). Default value `Secret Text' }
                \kve{title-public}{string}{Sets the name above the `player' text (if secret text is shown, and player text present). Default value is `Normal Text'}
                \kve{color}{color specifier}{Sets the outline color of the `secret box' rendered when the key is set to true.}
            \end{RpgTable}
        }
    {
    \RpgMacro[RpgSecret!Visible]{RpgSecretVisible}{\param{m}}{An alias for \cmd{RpgSwitch\param{ShowSecrets}\param{input}}}{}{
        % If the value is set to \texttt{true}, 
    }
    }

        \def\fmt{\color{gray!60}\small}
\def\lorumIpsumOne{{\fmt{}Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Ut purus elit,
 vestibulum ut, placerat ac, adipiscing vitae, felis. Curabitur dictum gravida mauris. }}
 \def\lorumIpsumTwo{{\fmt{}Nam arcu libero, nonummy eget,
consectetuer id, vulputate a, magna. Donec vehicula augue eu neque.
Pellentesque habitant morbi tristique senectus et netus et malesuada
fames ac turpis egestas. }}
\def\lorumIpsumThree{{\fmt{}Mauris ut leo. Cras viverra metus rhoncus
sem. Nulla et lectus vestibulum urna fringilla ultrices. Phasellus eu
tellus sit amet tortor gravida placerat. Integer sapien est, iaculis in,
pretium quis, viverra ac, nunc. }}
\begin{figure}[H]

 \begin{ExampleBlock}[false,RpgSecret,RpgSwitch]{RpgSecrets (in hide-mode)}
  %%hide the juicy gossip
  \RpgSwitch{ShowSecrets}{false}
  
  \lorumIpsumOne%Snippets of standard lorum ipsum
  \begin{RpgSecret}{}
    The players don't know it yet, but all this pseudo-latin text is a hint that devils are involved!  
  \end{RpgSecret}
   \lorumIpsumTwo{}
   \begin{RpgSecret}{
     Logos kykloforia, thelxis kai ethos, tyrannis kai epilysis. Aei thera plaka, kyrios meion egestas, anagkas proin eira kai thera.
     }
    
     This bit of text is noteworthy - it's been added in after the fact
  \end{RpgSecret}
   \lorumIpsumThree
 \end{ExampleBlock}
\end{figure}
\begin{figure}[H]
 \begin{ExampleBlock}[true,RpgSecret,RpgShowSecrets]{RpgSecrets (in show-mode)}
  %%exactly the same as above -- but reveal the secrets!
  \RpgSecretVisible{true} 
  \lorumIpsumOne
 
  \begin{RpgSecret}{}
      The players don't know it yet, but all this pseudo-latin text is a hint that devils are involved! 
  \end{RpgSecret}
 
   \lorumIpsumTwo{}
 
   \begin{RpgSecret}{Logos kykloforia, thelxis kai ethos, tyrannis kai epilysis. Aei thera plaka, kyrios meion egestas, anagkas proin eira kai thera.}
 
      This bit of text is noteworthy - it's been added in after the fact
  \end{RpgSecret}
 
   \lorumIpsumThree{}
 \end{ExampleBlock}
\end{figure}



\labelsection{RpgTable}

    \RpgMacro*{RpgTable}{\param{o m}}{Begins an environment for creating visually appealing and consistent tables. }{
        \cmd{begin}\param{RpgTable}[<options>]\param{<column-specifications}

        ~~~~{<table-contents>}

        \cmd{end\param{RpgTable}}
    }{
        RpgTable is a wrapper for the \forcelink{https://ctan.org/pkg/tabularx}{tabularx} (or \forcelink{https://ctan.org/pkg/xltabular}{xltabular} -- see \texttt{breakable}) environment, and so accepts the standard set of column specifications:\{c,l,r,p{width},\@,\ldots{}\} and the extended set (i.e. X). It therefore acts almost identically to the standard tabular environment with a few stylistic differences.
        \subsection{Stylistic Changes}
            The RpgTable environment makes the following changes:
            \begin{enumerate}
                \item \textbf{Title.} If the \texttt{title} option is set, a title-heading is rendered above the tablular in the font \cmd{RpgFontTableTitle}.
                \item \textbf{Auto-headings.} The first row of the tabular environment is automatically rendered in the font \cmd{RpgFontTableHeader}, allowing for trivial header labels.
                \item \textbf{Font Integration.} The main body of the table is rendered in \cmd{RpgFontTableBody}.
                \item \textbf{Auto-colouring.} The rows alternate between being transparent and being set to the \texttt{tablecolor} variable \RpgPage[p]{S:Colors}. This is powered by \texttt{rowcolors}.
            \end{enumerate}
        \subsection{Optional Arguments}
        \begin{description}
            \item[width=<dimexpr>] Fixes the width of the tabular environment to the value of this argument. Default value is the current \texttt{\bs{}linewidth}.
            \item[color=<color-name>] If set, uses this value instead of \texttt{tablecolor} for the alternating coloration.
            \item[title=<text>] Sets the text to be rendered as the title of the table. 
            \item[breakable] If flag is present, renders using \texttt{xltabular}, enabling the table to break over pages. \textbf{only available in 1-column mode (a fundamental limitation of xltabular).}
            \item[simple] If flag is present, renders using a simple \texttt{tabular} (ignoring breakable flag). Useful if not using X-columns, and not wanting to specify a length of the table. 
            \item[noheader] If flag is present, suppresses the autoformatting of the title. The first row is instead rendered in the body formatting.
        \end{description}
    }
    \subsection{RpgTable Example}


        This is the standard usage of the table, showing automatic formatting of the header rows and the word-wrapping abilities of the X-column:
 \begin{ExampleBlock}{Standard RpgTable}
 \begin{RpgTable}[width=0.75\linewidth, color=green!30!white]{lX}
 Header 1 & Header 2
 \\
 Text & Some text which fills up the space to 75\% of the line width then breaks
 \\
 Alternating & This row is transparent
 \\
 Colour & but this one is the colour we set in the header
 \end{RpgTable}
 \end{ExampleBlock}
 This example adds a title, but suppresses the header formatting:
 \begin{ExampleBlock}{Header-Suppressed RpgTable}
 \begin{RpgTable}[title={Test Table},noheader]{XlX}
 Plain & Header & Text
 \\
 Now there's no & difference & between the header and the main
 \\
 body
 \end{RpgTable}
 \end{ExampleBlock}

\labelsection{Text Boxes}

    \rpgtex{} defines three `colorbox' environments, which inherit from \tcref{}. These provide a consistent way for a writer to highlight and differentiate blocks of text on the page.

    \begin{RpgSidebar}{Which colorbox to use?}
        
        The choice between RpgSidebar and RpgTip is somewhat arbitrary -- although they have a mechanical difference by default (one being breakable, the other not) -- this can be overridden by themes. Instead, the intention is that they serve slightly different purposes:
        
        \begin{description}
                        \item[RpgSidebar] is used for `important information' -- key rules or summaries which readers \textit{should} pay attention to.
                        \item[RpgTip] is for `helpful additions' -- tips, tricks and trivia that are not necessary, but which might be useful, and are too big to fit into a footnote or parenthetical.   
        \end{description}
    \end{RpgSidebar}

    All of the boxes inherit the standard `tcb' style interface, and so tcolorbox options may be passed by the user to control their appearance.

    \RpgMacro*{RpgNarration}{\param{{o}}}{A \tcref{} wrapper designed for text that is read aloud to players}
        {
            \texttt{\bs{}begin\param{RpgNarration}[color=<color>,<tcbox-options>]}

            ~~~~\texttt{<text>}
            
            \cmd{end\param{RpgNarration}}
        }{
            RpgNarration does not (by default) set a title, using only `body text', which is typeset using the \texttt{RpgFontNarration} font. The optional \texttt{<tcbox-options>} argument can be a list of all the basic tcolorbox options (see that documentation). The \texttt{color} argument is an alias for \texttt{colback} (\texttt{colbacktitle} is also set, but is ignored as the title is empty). Due to the order of processing, if both \texttt{color} and \texttt{colback} are set, the value of \texttt{colback} is used.

            Themes may alter the appearance of the narration block using the tcb interface, calling \texttt{\bs{}tcbset\param{rpgnarration /.append~style={...}}} to overwrite the existing instructions.
        }

   \begin{ExampleBlock}[RpgNarration]{RpgNarration}
    \begin{RpgNarration}[color=blue!30!white]
     This is text that you would read out loud to players, describing a scene. It will always be blue, even if the theme says otherwise -- because the optional argument takes priority.
    \end{RpgNarration}
   \end{ExampleBlock}

    \RpgMacro*{RpgSidebar}{\param{{o m}}}{A decorated \tcref{} wrapper designed for information which is set outside the main text.}
        {
            \cmd{begin\param{RpgSidebar}[color=<color>,<tcbox-options>]\param{<title>}}

            ~~~~{<text>}
            
            \cmd{end\param{RpgSidebar}}
        }{
            RpgSidebar requires a title (using \texttt{RpgFontSidebarTitle}) as well as the body text (\texttt{RpgFontSidebarBody}). 	RpgSidebar is typically more highly decorated than RpgTip, and does not have the \texttt{breakable} flag set. It is usually best to use one of the `float' options.
            
            The optional \texttt{<tcbox-options>} argument can be a list of all the basic tcolorbox options (see that documentation). The \texttt{color=x} argument is equivalent to calling both \texttt{colback=x} and \texttt{colbacktitle=x}. Due to the order of processing, if both \texttt{color} and \texttt{colback} are set, the value of \texttt{colback} is used.


            Themes may alter the appearance of the sidebar using the tcb interface, calling \texttt{\bs{}tcbset\param{rpgsidebar /.append~style={\ldots}}} to overwrite the existing instructions.
        }
    \begin{ExampleBlock}[RpgSidebar]{RpgSidebar}
    \begin{RpgSidebar}{A Sidebar}
     This is an important block of text, that you should pay attention to.
    \end{RpgSidebar}
   \end{ExampleBlock}
    \RpgMacro*{RpgTip}{\param{{o m}}}{A simple \tcref{} wrapper designed for information which is set outside the main text.}
        {
            \cmd{begin\param{RpgTip}[color=<color>,<tcbox-options>]\param{<title>}}

            ~~~~\texttt{<text>}
            
            \cmd{end\param{RpgTip}}
        }{
            RpgTip is similar to RpgSidebar, requiring a title (\texttt{RpgFontTipTitle}) in addition to the body text (\texttt{RpgFontTipBody}). However, it is generally simpler, enabling it to safely break over page boundaries. The optional \texttt{<tcbox-options>} argument can be a list of all the basic tcolorbox options (see that documentation). The \texttt{color=x} argument is equivalent to calling both \texttt{colback=x} and \texttt{colbacktitle=x}. Due to the order of processing, if both \texttt{color} and \texttt{colback} are set, the value of \texttt{colback} is used.

            Themes may alter the appearance of the narration block using the tcb interface, calling \texttt{\bs{}tcbset\param{rpgnarration /.append~style={...}}} to overwrite the existing instructions.
    }

    

    \begin{ExampleBlock}[RpgTip]{RpgTip}
    \begin{RpgTip}{A Tip}
     This is some helpful - but not vital - text.
    \end{RpgTip}
    \end{ExampleBlock}


\section{RpgItem, RpgSpell, RpgFeat (etc.)}

    The prior documented environments have almost entirely been \textit{rules agnostic}. That is, they have primarily been typesetting aids which could equally be used for notes on a whimsical, rules-lite game about squirrels in a forest, or a crunchy, table-heavy futuristic scifi game -- all the theme did was change the appearance of the individual elements. 
    
    Some elements, however, are strongly tied not only to an aesthetic theme, but also to the rules of an individual system: a statblock for a Pathfinder monster not only looks wholly different to a hostile Traveller alien, but has different components and arguments.
    
    To this end, we have provided a powerful and flexible interface to allow a designer to create and customise environments. This is the subject of Chapter \ref{S:Forge}, and makes it somewhat difficult to robustly document the features - as they change behaviour depending on the theme that is being used! When using these functions, always consult the theme-specific documentation.

    

\begin{RpgSidebar}{Advanced Usage}
    The functions listed below are the `basic interface' for the FeatureForge system; designed for those who are happy to use the format that a theme designer has set up for them. 

    Those wishing to have a more fine-grained control over the appearance of the objects should consult the full documentation on page \RpgPage[p]{S:Forge}.
\end{RpgSidebar}

    By default, all of these environments have the same behaviour (except where noted otherwise)

        
        \begin{ExampleBlock}[TestObject]{Feature Forge Example}
%% Test object does not exist before this moment.
%%See FeatureForge for documentation
\RpgMakeFeature{TestObject}{TestCard}{test}
\TestObjectAddProperty{test-key} {\testKeyValue} {default}


%card mode defaults to false, so get plain text output:
\begin{TestObject}{An Example}
    This is the body text, I can see that my key is `\getkey{test-key}'
\end{TestObject}

%%Then activate the card mode (and change the test-key value)
\TestObjectShowCard{true}
\begin{TestObject} {An Example} [test-key=alacrity]
    This is the body text, I can see that my key is `\getkey{test-key}'
\end{TestObject}
        \end{ExampleBlock}

	\label{RpgItem}\label{RpgSpell}\label{RpgFeat}
    \RpgMacro*[RpgItem,RpgSpell,RpgFeat]{Rpg[X]}{{RpgItem},{RpgSpell},{RpgFeat},\param{\paramO{} m \paramO}}{A card-switching environment which renders the text either in normal text, or as an \envref{RpgCard} }
    {
        \cmd{begin}\param{Rpg[X]}[<card-opts>]\param{<name>}[<cmd-opts>] \% replace [X] with `Item/Feat/Spell'

        \ldots
    }{
        All environments following this pattern are based off the Switched-Environment system \RpgPage[p]{S:SwitchEnv}, allowing them to render the same text either in normal (`text') mode, or in card-mode, depending on the value set by the user. The optional \texttt{card-opts} parameter is passed as the optional parameter to the RpgCard environment, allowing the user to customise the card's appearance.

        The \texttt{name} parameter defines the object and will (usually) appear in a title/subtitle/subsubtitle. 

        The main flexibility of the system is delivered through the \texttt{<cmd-opts>} argument, which accepts key/value pairs. The keys are determined by the theme (there are none by default), and define rules-based interactions (a D\&D theme might add an `armour-class' key, whilst a Forged in the Dark theme might add `tier'). Consult the theme-documentation for the present definition of the keys.
    }{}

	%has to be outside environment for some reason
    \RpgMacro[RpgItem!ShowCard,RpgSpell!ShowCard,RpgFeat!ShowCard]{Rpg[X]ShowCard}{\param{m}}{Sets the card mode for all Rpg[X] environments. }{
        \cmd{Rpg[X]ShowCard\param{true/false}}
    }{
        If set to true, the contents of the specified environment will be rendered in card-mode, or text-mode if false.
    }
	
    \RpgMacro{getkey}{\param{m}}{Inserts the value passed to \texttt{key} in the \texttt{cmd-opts} args of the current [X]-environment}
        {
            \cmd{begin}\param{Rpg[X]}\param{Test Object}[key1=value,key2=value]
    
            \{

            ~~The value of key1 is \cmd{getkey}\param{key1}

            \}
        }
        {\label{S:getkey1}
            % The writer may then reference the parameters of the object they are creating from within the body text of the environment, preventing duplication of information. 
            % 
            Recovers the value passed to the key (after any post-processing performed by the environment). This allows the user to access the key-values, as well as allowing them to be inserted into the expected formatting, without having to duplicate the information.

            See \RpgPage{S:getkey2} for more details.
        }
    
    