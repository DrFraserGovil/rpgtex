
\chapter{Installation \& Usage}

	\section{Getting \rpgtex}

		There are a number of different ways to acquire \rpgtex{}. Once you have installed it, it is vital to ensure that it is \href{\ref{S:Configuration}}{properly configured} (see below).


		\subsection{texmf Installation}

			The simplest way to use \rpgtex{} is to install it on the \texttt{texmf} path, where the compiler can automatically find it:

			\begin{lstlisting}
git clone https://github.com/DrFraserGovil/rpgtex.git "$(kpsewhich -var-value TEXMFHOME)/tex/latex/rpgtex"
			\end{lstlisting}

			This will clone the repository into your\LaTeX{} path.

		\subsection{Indirect Installation}

			If you want to tinker with \rpgtex{} -- such as by creating a new theme -- it is helpful to have it in a more accessible location. Clone the repository into a location of your choice:

			\begin{lstlisting}
git clone https://github.com/DrFraserGovil/rpgtex.git ~/your/rpgtex/directory
			\end{lstlisting}

			You then have two options to make the package visible to the compiler:

			\subsubsection{Use TEXINPUTS}

			Setting the environment variable \verb|TEXINPUTS| allows the compiler access:
				\begin{lstlisting}
	TEXINPUTS=~/your/rpgtex/directory/::
				\end{lstlisting}
				(Or similar commands, depending on your shell -- in \texttt{fish} you would call \verb|set TEXINPUTS dir|).

			\subsubsection{Use Symlinks}

			You can symlink the install location to the texmf directory, allowing the compiler to act as if you had performed the texmf installation:

			\begin{lstlisting}
				ln -sf ~/your/rpgtex/directory "$(kpsewhich -var-value TEXMFHOME)/tex/latex/rpgtex"
			\end{lstlisting}

		\subsection{Overleaf (Not recommended!)}

			We do not recommend using Overleaf since the free-tier subscription has reduced compilation times drastically, making compiling documents using complex packages such as this one extremely difficult. Nevertheless:

			\begin{enumerate}
				\item  Download this GitHub repository as a ZIP archive using the Clone or download link above.
    			\item On Overleaf, click the New Project button and select Upload Project. Upload the ZIP archive you downloaded from this repository.
				\item Manually create the file \texttt{rpg-config.cfg} with the contents ``\verb|\edef\RpgPackagePath{../}|''. This replaces the configuration step described below.
			\end{enumerate}


	\section{Configuring \rpgtex{}}\label{S:Configuration}

		Wherever one installs \rpgtex{} from, it is vital that it is properly configured. From within the \rpgtex{}-root directory, call:

		\begin{lstlisting}
			./configure
		\end{lstlisting}
		Or -- if one is (reasonably!) wary about running arbitrary executables -- manually create the relevant file:
		\begin{lstlisting}
			cd <rpgtex root directory>
			cmd="\edef\RpgPackagePath{$(pwd)}"
			echo $cmd >> core/rpg-config.cfg
		\end{lstlisting}

		\begin{RpgTip}{Why is configuration necessary?}
			\TeX{} is generally set up so that when a file calls \verb|include| or \verb|input| it is possible to use filepaths relative to the package itself. \texttt{rpg.sty} can call \verb|\input{core/font.sty}| and it will know to first check for the file relative to rpg.sty; even if the package resides within the texmf path and the user has no idea where \texttt{rpgroot/rpg.sty}, or \texttt{rpgroot/core/font.sty}, are.

			An annoying exception to this is fonts and typefaces. \texttt{xelatex} searches for fonts based on \textit{filepaths relative to the current working directory} -- or from those installed in as system fonts.

			Since \texttt{rpgtex} includes several (license free) typefaces as part of the provided themes, this poses a problem. We must either require that:
			\begin{enumerate}
				\item \rpgtex{} documents can only be prepared in restricted locations relative to the install location of \rpgtex{}.
				\item Users must identify and specify the \rpgtex{} root path when preparing a document
				\item Users must install the provided fonts to the system path
				\item \rpgtex{} must be configured to know `where it is', and so provide an absolute filepath to the internal fonts.
			\end{enumerate}
			The Configuration step is the most portable and easiest-to-use of these options.
		\end{RpgTip}

		Without a \texttt{core/rpg-config.cfg} file, any document which includes \rpgtex{} will fail to compile.
	\newpage

	\section{Package \& Class Usage}

		\rpgtex{} can be used either as a standalone package, or as part of a number of classes

		\subsection{Standalone Package}
			The standalone package can be used directly by including the \rpgtex{} package:
			\begin{lstlisting}
				\documentclass{arbitrary-class}

				\usepackage[options]{rpgtex}

				\begin{document}
				....
			\end{lstlisting}

			This will load only the core commands into the document, and (unless called explicitly) no themes will be imported. Using the package in this way does not activate any of the commands which change the overall geometry, background or headers of the document.

		\subsection{Classes}

			\rpgtex{} can also be loaded through a number of classes which drastically alter the appearance of the document, defining new geometries backgrounds and adding headers.

			The provided classes are:
			\begin{enumerate}
				\item \texttt{rpgbook} (\RpgPage{S:bookClass}). Based on the standard book class, this is designed for larger RPG documents.
				\item \texttt{rpghandout} (\RpgPage{S:handoutClass}). Based on the article class, this is designed for shorter documents
				\item \texttt{rpgcard} (\RpgPage{S:cardClass}). A small-document class designed for creating modular `handout' cards for items, spells or abilities.
			\end{enumerate}
	\section{Compiling}

		\rpgtex{} uses the \texttt{fontspec} package to allow custom fonts, and therefore requires compiling with \texttt{xelatex} or \texttt{luatex}:

		\begin{lstlisting}
			xelatex main.tex		#works
			luatex main.tex			#works
			pdflatex main.tex #fails
		\end{lstlisting}

\onecolumn

% \begin{myverbbox}{\RpgPluralCode}

% \end{myverbbox}


\chapter{Core Commands}

	\blindtext{}



	\section{Document Commands}

		\begin{macrolist}
			\RpgMacro{\RpgDice,{{m}}}
				{\label{Macro:Dice}
					Evaluates expressions of the form $n\mathrm{d}x + m$, and outputs using a theme-dependent layout.
				}
				{
					\RpgDice{<dice-expression>}
				}{
					Uses regular expressions to extract and evaluate the dice expression. The \verb|dice-expression| must follow the following format:
					\begin{enumerate}
						\item It must contain either `d' or `D' (the `dice symbol')
						\item The dice symbol must be immediately followed by a single number (the `dice size')
						\item The dice symbol may optionally be prefixed by a single number (the `dice count')
						\item The first (non-whitespace) character must be either the dice count (if present) or the dice symbol
						\item The dice size must be followed by either a `+', '-', or the end of the expression.
						\item After this, any number of standard numeric expressions may follow. This expression will be evaluated into a single `modifier'.
					\end{enumerate} 
					\begin{RpgTable}{XX}
						Example & Output \\
						\tabverbExample{\RpgDice{1d6-2}}
						\tabverbExample{\RpgDice{2D6 + 3*2^2}}
						\tabverbExample{\RpgDice{1d16}}
						\tabverbExample{\RpgDice{d8-3}}
					\end{RpgTable}
					\newline\vspace{1em}
					{\RpgFontSubsubsection{} Themes}
					\newline
					\verb|RpgDice| is neat, but not necessarily impressive by itself. The true power of the expression is that it calls \verb|RpgDiceFormat| (\RpgPage{Macro:DiceFormat}) on the internal values. This is a value which can be overwritten by themes, and allows (for instance), the \verb|dnd| theme to compute mean values, as is found in D\&D monster stat blocks:
					
					\RenewDocumentCommand{\RpgDiceFormat}{m m m}{\DndTempDiceFormat{#1}{#2}{#3}}

					
					\begin{RpgTable}{XX}
						Example (with \verb|\RpgSetTheme{dnd}|) & Output \\
						\tabverbExample{\RpgDice{1d6-2}}
						\tabverbExample{\RpgDice{2D6 + 3*2^2}}
						\tabverbExample{\RpgDice{1d12}}
						\tabverbExample{\RpgDice{d83-3}}
					\end{RpgTable}

				
				}
			\RpgMacro{\RpgOrdinal,{{o m}}}
				{
					Converts a numeric value to the corresponding ordinal.
				}
				{
					\RpgOrdinal[<command>]{<count>}
				}
				{
					The command outputs the \verb|count| followed by the english abbreviations for the corresponding ordinal. The optional \verb|command| argument is inserted between the numeral and the suffix, allowing for the customisation of appearances.
					\begin{RpgTable}{XX}
						Example & Output \\
						\tabverbExample{\RpgOrdinal{1}}
						\tabverbExample{\RpgOrdinal{2}}
						\tabverbExample{\RpgOrdinal{13}}
						\tabverbExample{\RpgOrdinal[\textsuperscript]{7}}
						\tabverbExample{\RpgOrdinal[\textbf]{133}}
						\tabverbExample{\RpgOrdinal[<arbitrary text>]{133}}
					\end{RpgTable}
					{\it Note that due to a lack of brace-capturing, it is not possible to chain multiple commands.}.
				}
			\RpgMacro{\RpgPage,{{O{t} m}}}
				{
					Outputs the current page reference for a label, with an option to enclose it in specific brackets or parentheses.
				}
				{
					\RpgPage[t/p/b/c]{<label-reference>}
				}
				{
					The optional arguments wrapping of the main reference. The options are:
					\begin{description}
						\item[t (default)] No wrapping
						\item[p] (parentheses)
						\item[b] [square brackets]
						\item[c] \{curly braces\}
					\end{description}
					An invalid input resolves to \verb|?page~\pageref{<ref}?|. 
					\label{example:current page}
					\begin{RpgTable}{XX}
						Example & Output \\
						\tabverbExample{\RpgPage{example:current page}}
						\tabverbExample{\RpgPage[p]{example:current page}}
						\tabverbExample{\RpgPage[b]{example:current page}}
						\tabverbExample{\RpgPage[c]{example:current page}}
						\tabverbExample{\RpgPage[(error)]{example:current page}}
					\end{RpgTable}
				}
			\RpgMacro{\RpgPlural,{{o m m}}}
				{
					Generates grammatically correct plural forms of a word based on a given count.
				}
				{
					\RpgPlural[<custom-plural>]{count}{<text>}
				}
				{
					The command outputs the count followed by the value of \verb|<text>|. For a count of 1, the command then finishes. For any other count, it appends an ``s'', pluralizing the text.

					The optional argument \verb|[<custom-plural>]| overrides the default logic, allowing for irregular plurals.


					\begin{RpgTable}{XX}
						Example & Output \\
						\tabverbExample{\RpgPlural{1}{hat}}
						\tabverbExample{\RpgPlural{2}{hat}}
						\tabverbExample{\RpgPlural[octopodes]{1}{octopus}}
						\tabverbExample{\RpgPlural[octopodes]{359}{octopus}}
					\end{RpgTable}
				}

			
		\end{macrolist}

	\section{Theme Commands}

		\begin{macrolist}
			\RpgMacro{\RpgDiceFormat,{{m m m}}}
				{\label{Macro:DiceFormat} Prints the values computed by \verb|RpgDice| \RpgPage[p]{Macro:Dice}
				}
				{
					\RpgDiceFormat{<dice-count>}{<dice-size>}{<added bonus>}
				}
				{
					This function is used by theme designers to determine how \verb|RpgDice| is rendered. The default option is:
					\verb|\RpgDiceFormat{m m m} { #1d#2 #3}|, such that \verb|RpgDice{ndx + a + b}| gives ``ndx + c'', where c is the numerical value of a+b, with an additional check to see if \verb|#3| is equal to 0, in which case it is not printed (so as not to `1d6 + 0'). 
					
					The dnd implementation performs a more advanced operation, computing the average value of the roll, and formatting that first, to replicate the format used by monster stat blocks. 

					\verb|RpgDiceFormat| is loaded in both \verb|layout| and non-\verb|layout| calls.
				}
			\RpgMacro{\RpgLayoutOnly,{{m}}}
				{
					Executes the contents of the command if \verb|layout| mode is active.
				}
				{
					\RpgLayoutOnly{<content-to-execute>}
				}
				{
					If the internal value \texttt{\textbackslash{}l\_\_rpg\_layout\_bool} is True, then \verb|content-to-execute| is run, otherwise it is ignored.

					This command is primarily used by theme developers and document class files to conditionally load or activate modules based on whether the package was loaded via a document class (layout mode active) or directly via \verb|\usepackage{rpgtex}|.
				}
			\RpgMacro{\RpgSetTheme,{{m}}}
				{
					Activates a chosen theme.
				}
				{
					\RpgSetTheme{<theme-name>}
				}
				{
					Searches for the file \verb|<theme-path>/<theme-name>/<theme-name>.cfg|, and inputs it. If this is a properly configured theme file, then it activates the chosen theme given the current global parameters. If the file does not exist, throws an error.

					If   \texttt{\textbackslash{}l\_\_rpg\_layout\_bool} is True, the command automatically inserts \verb|\clearpage|, as required to ensure the old headers are not overwritten by the new theme.

					\verb|<theme-path>| is modified via \verb|RpgSetThemePath|.
				}

			\RpgMacro{\RpgSetThemeColor,{{m}}}
				{\label{Macro:SetThemeColor}
					Sets the \verb|themecolor|, and simultaneously updates the co-varying colors \RpgPage[p]{S:Colors}.
				}{
					\RpgSetThemeColor{color-name}
				}{
					If \verb|color-name| specifies a valid color, then the value of \verb|themecolor| is updated, as well as a number of other colors (\verb|tipcolor|, \verb|sidebarcolor| and \verb|tablecolor|) which are set to be equal to the themecolor by default.

					Of the rpg-provided colors, only \verb|narrationcolor| is unaffected by this command.
				}
			\RpgMacro{\RpgSetThemePath,{{m}}}
				{
					Changes the value of the theme path searched for by \verb|RpgSetTheme|
				}
				{
					\RpgSetTheme{<path-name>}
				}
				{
					Updates an internal variable to be equal to the input value; does not check if the theme path is valid or not. Useful if you wish to create a new theme outside of the \verb|rpgtex| file structure.
				}
		\end{macrolist}
	\section{Variables}
		\subsection{Colo(u)rs}\label{S:Colors}

			\rpgtex{} by default defines five colors\footnote{Yes, I hate myself, but we're going with the code-based spelling.} which are used for different elements:
			\begin{description}
				\item[themecolor] A `basic color' which is (by default) equal to the following three colors:
				\begin{enumerate}
					\item \textbf{sidebarcolor} The background color of the \verb|RpgSidebar| environment
					\item \textbf{tablecolor} The background color of every other row in an \verb|RpgTable| 
					\item \textbf{tipcolor} The background color of the \verb|RpgTip| environment 
				\end{enumerate} 
				\item[narrationcolor]  The background color of the \verb|RpgTip| environment 
			\end{description}

			Calling \verb|\RpgSetThemeColor| \RpgPage[p]{Macro:SetThemeColor} updates the value of \verb|themecolor|, as well as the three `co-varying' colors (i.e. everything except \verb|narrationcolor|). When \verb|printmode| is active \verb|\RpgSetThemeColor{white}| is called, making environments transparent.
