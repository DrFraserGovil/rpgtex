\ExplSyntaxOn

\RequirePackage{fontspec} %%for xelatex fontss
\RequirePackage[T1]{fontenc}
\RequirePackage{lettrine} %%fancy drop cap
\RequirePackage{Royal} %%Used for fancy drop caps
\RequirePackage[auto]{contour} %%for outlining text
\RequirePackage{relsize} %%used for bigger/smaller

\sys_if_engine_pdftex:T
{
  % Spit out a warning if wrong compiler used
  \msg_new:nnn { rpg } { wrong-compiler }{#1}
  \msg_error:nnx { rpg } { wrong-compiler }
	{
		 rpgtex~requires~compilation~with~xelatex~or~luatex
	}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%Automatic font generation
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

	%%This function allows a user to enter a font specification into the registry with a single line of code
	%%It can then be modified with RpgSetFont and accessed using the assigned name
	%%Note that we explicitly do not provide any default values: that's a job for the theme.

	\NewDocumentCommand{\RpgCreateFont}{m m}
	{
		%%Add entries into the registry
		%%Dynamically creates cs-sequences
		\exp_args:Ne\keys_define:nn{rpg/fonts}
		{
			#2-family .tl_set:c = l__#2_family,
			#2-family .value_required:n = true,
			#2-family .initial:n = {},
			#2-style .tl_set:c = l__#2_style,
			#2-style .value_required:n = true,
			#2-style .initial:n = {},
		}

		%%Create the font-access command from the provided name
		\NewDocumentCommand{#1}{}{
			\use:c {l__#2_family} \use:c{l__#2_style}
		}
	}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%Available font elements
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

	%%%%%%%%%%%%
	%%Main body
	%%%%%%%%%%%%
	\RpgCreateFont{\RpgFontBody}{main-body}
	\RpgCreateFont{\RpgFontEmphasis}{emph}

	%%%%%%%%%%%%
	%%Sections
	%%%%%%%%%%%%
	\RpgCreateFont{\RpgFontTitle}{title}
	\RpgCreateFont{\RpgFontSubTitle}{subtitle}
	\RpgCreateFont{\RpgFontPart}{part}
	\RpgCreateFont{\RpgFontChapter}{chapter}
	\RpgCreateFont{\RpgFontSection}{section}
	\RpgCreateFont{\RpgFontSubsection}{subsection}
	\RpgCreateFont{\RpgFontSubsubsection}{subsubsection}
	\RpgCreateFont{\RpgFontParagraph}{paragraph}
	\RpgCreateFont{\RpgFontSubparagraph}{subparagraph}

	%%%%%%%%%%%%
	%%Environments
	%%%%%%%%%%%%
	\RpgCreateFont{\RpgFontTableTitle}{table-title}
	\RpgCreateFont{\RpgFontTableHeader}{table-header}
	\RpgCreateFont{\RpgFontTableBody}{table-body}
	\RpgCreateFont{\RpgFontTipTitle}{tip-title}
	\RpgCreateFont{\RpgFontTipBody}{tip-body}
	\RpgCreateFont{\RpgFontSidebarTitle}{sidebar-title}
	\RpgCreateFont{\RpgFontSidebarBody}{sidebar-body}
	\RpgCreateFont{\RpgFontNarration}{narration}
	\RpgCreateFont{\RpgFontAbstractTitle}{abstract-title}
	\RpgCreateFont{\RpgFontAbstractBody}{abstract-body}
	\RpgCreateFont{\RpgFontSecretTitle}{secret-title}

	%%%%%%%%%%%%
	%%Cards
	%%%%%%%%%%%%
	\RpgCreateFont{\RpgFontCardTitle}{card-title}
	\RpgCreateFont{\RpgFontCardHeader}{card-header}
	\RpgCreateFont{\RpgFontCardBody}{card-body}

	%%%%%%%%%%%%
	%%TOC
	%%%%%%%%%%%%
	\RpgCreateFont{\RpgFontTocPart}{toc-part}
	\RpgCreateFont{\RpgFontTocChapter}{toc-chapter}
	\RpgCreateFont{\RpgFontTocSection}{toc-section}

	%%%%%%%%%%%%
	%%Statblocks
	%%%%%%%%%%%%
	\RpgCreateFont{\RpgFontStatBlockTitle}{stat-block-title}
	\RpgCreateFont{\RpgFontStatBlockBody}{stat-block-body}
	\RpgCreateFont{\RpgFontStatBlockSection}{stat-block-section}

	%%%%%%%%%%%%
	%%Decoration
	%%%%%%%%%%%%
	\RpgCreateFont{\RpgFontFooter}{footer}
	\RpgCreateFont{\RpgFontPageNumber}{page-number}
	\RpgCreateFont{\RpgFontDropCap}{drop-cap}
	\RpgCreateFont{\RpgFontDropCapFirstLine}{drop-cap-first-line}

	



% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% %Set font values
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	\NewDocumentCommand { \RpgSetFont } { m }
	{
		\keys_set:nn { rpg / fonts } { #1 }
		\renewcommand\normalfont\RpgFontBody
		\renewcommand{\FirstLineFont}{\RpgFontDropCapFirstLine}
		\normalfont
	}

	%ensure the assigned normalfont is loaded when document begins
	\AtBeginDocument{
		\normalfont	
	}	
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% %Keywords & Emphasis
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

	\RenewDocumentCommand{\emph}{m}
	{
		{\RpgFontEmphasis #1}
	}
	\NewDocumentCommand{\key}{m}
	{
		\emph{#1}
	}

% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% % RpgDropCap
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

	\renewcommand{\LettrineFontHook} %feed the desired font into the lettrine pipeline
	{ \RpgFontDropCap}

	% Usage: rpgDropCapLine[<lettrine options>]{<first letter>}{<small caps line>}
	%    It takes trial and error to get the 2nd argument to align with
	%    the linebreak. See the lettrine package for options.
	\RequirePackage{magaz}
	\NewDocumentCommand{\RpgDropCap}{ O{} m m }
	{
		\lettrine[
			lines   = 4,
			depth   = 0,
			findent = \l__rpg_space_dim,
			nindent = 0pt,
			#1
		]
		{#2}{}
		\FirstLine{#3}
	}

% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% % RpgContour 
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	% decoration that can break across lines. Can accept \newline to force a break.
	\input{core/lowlevel/contour.tex} %%It's gross so I've put the expl3 in a lowlevel

	\NewDocumentCommand{\RpgContour}{O{} m}
	{
		\group_begin:
		\keys_set:nn {rpg/contour}{#1}
		
		\exp_args:Nf \__rpg_contour_split_lines:n {#2}

		\group_end:
	}
