\ExplSyntaxOn

\input{core/lowlevel/regex}
\input{core/lowlevel/ordinal.tex}
\input{core/lowlevel/misc}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Dice macro
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\cs_new:Nn \__rpg_dice_formatter:nnn{#1d#2#3}

\DeclareDocumentCommand{ \RpgDiceFormat} {m}
{
	%Arguments: #1: Dice Number, #2: Dice Sides, #3: Modifier

	\cs_set:Nn  \__rpg_dice_formatter:nnn{#1}
}

\DeclareDocumentCommand { \RpgDice } { m }
{
	%%Parses input of the form { #d# | d# | #d# ± # | d# ± #}
	%%Final argument (the ± term) can be arbitrary arithmetic statements
	%%Passes the output to RpgDiceFormat
	
	\__rpg_dice_parse:n {#1}
	
	%%Parsing function defined in lowlevel/regex
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Text Formatting
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%Pluralises words based on the tokens
\NewDocumentCommand{\RpgPlural}{s o m m }
{
	%if unstarred, add no.
	\IfBooleanF{#1}
	{
		#3~
	}
	% #2: override plural (replaces +s) #3 count #4 word/phrase to be checked
	\int_compare:nTF {#3  = 1 }
	{
		#4
	}
	{
		\IfNoValueTF{#2}
		{
			#4s
		}
		{
			#2
		}
	}
}


% takes an integer and outputs the ordinal text
% internal functions defined in lowlevel/ordinal.tex
\NewExpandableDocumentCommand{\RpgOrdinal}{o m}
{
    % Output the number first
    \int_to_arabic:n { #2 }
	%then the calculated suffix
	\IfNoValueTF{#1}
	{
		\__compute_ordinal_suffix:n { #2 }
	}
	{
		%Allow for arbitrary token insertion between the two (i.e. for formatting)
		#1{\__compute_ordinal_suffix:n { #2 }}
	}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%
% Referencing
%%%%%%%%%%%%%%%%%%%%%%%%%%

\NewDocumentCommand{\RpgPage}{O{t} m}
{
    % O{t}: Optional argument #1 (default is 't' for standard 'text' style)
    % m: Mandatory argument #2 (the label)

    \def\temp@content{page~\pageref{#2}}

	\str_case:nnF {#1}
	{
		{p}{(\temp@content)}
		{b}{[\temp@content]}
		{c}{\{\temp@content\}}
		{t}{\temp@content}
	}
	{
		?\temp@content?
	}
}


