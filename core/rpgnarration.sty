\ExplSyntaxOn

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Environment for read-aloud text.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Standard for every read-aloud text


\DeclareTColorBox {__rpg_narration} {o}
  {
	rpg narration,
    #1,
  }

% Extra key for controlling the color of the title and the background
\keys_define:nn { rpg / narration }
  {
    color .tl_set:N         = \l__rpg_narration_color_tl,
    color .initial:n        = narrationcolor,
    color .value_required:n = true,
  }

% This function, through its variant, forces the expansion of the tcb keys
% passed to the environment by the user before it invokes the tcolorbox
\cs_new_protected:Nn \__rpg_start_narration:nn
  {
    \begin {__rpg_narration} [ #1, #2 ]
  }

\cs_generate_variant:Nn \__rpg_start_narration:nn { nV }

% The RpgNarration environment
% #1 - keys. We handle the custom color key before passing other keys on
\NewDocumentEnvironment {RpgNarration} {o}
  {
    \group_begin:
    \keys_set_known:nnN { rpg / narration } {#1} \l_tmpa_tl

    \str_if_eq:VnT \l_tmpa_tl { -NoValue- }
      { \tl_set_eq:NN \l_tmpa_tl \c_empty_tl }

    \__rpg_start_narration:nV
      {
          colback = \l__rpg_narration_color_tl,
      }
      {\l_tmpa_tl}
  }
  {
    \end {__rpg_narration}
    \group_end:
  }
