
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Map Areas and their References
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ExplSyntaxOn

\input{core/lowlevel/map}
 \keys_define:nn { rpg / areas }
  {
	depth 	.tl_set:N 			= \l__rpg_manual_level_tl,
	depth	.value_required:n 	= true,
	depth	.initial:n			= 0, 
	title	.tl_set:N			= \l__rpg_map_title_tl,
	title	.value_required:n	= true,
	title	.initial:n			={},
	prefix	.tl_set:N			=\l__rpg_map_prefix_tl,
	prefix	.value_required:n	=true,
	prefix	.initial:n			={},
	blank-prefix .tl_set:N		=\l__rpg_map_blank_prefix_tl,
	blank-prefix	.value_required:n	=true,
	blank-prefix	.initial:n			={Area~},
	ref-prefix .tl_set:N		=\l__rpg_map_ref_tl,
	ref-prefix .value_required:n	=true,
	ref-prefix	.initial:n	= {Map:},
  }


\NewDocumentEnvironment{RpgMap}{o}
{
	\group_begin:   
	\__rpg_construct_parent_prefix:

	\IfNoValueF{#1}
	{
		\keys_set:nn { rpg / areas } {#1}

		\int_compare:nT { \value{RpgAreaDepth} = 1 }
		{
			\str_if_empty:nF \l__rpg_map_title_tl
			{
				\__rpg_render_heading_level:nf {\l__rpg_manual_level_tl{}}{\l__rpg_map_title_tl} 
			}
		}
	}
}
{
	\__rpg_end_map_block:
	\group_end:
}


\NewDocumentEnvironment{RpgMap*}{o}
{
	\group_begin:   
	\bool_set_true:N\l__rpg_map_starred_bool
	\begin{RpgMap}[#1]
}
{
	\end{RpgMap}
	\group_end:
}


\NewDocumentCommand{\RpgArea}{o m}
{
	\IfNoValueF{#1}
	{
		\bool_set_true:N \l__use_label
		\tl_set:Ne \l__label{#1}
	}

	\__rpg_map_increment_counter:
	
	\__rpg_map_construct_title:n {#2}

	\bool_set_false:N \l__use_label
}

\NewDocumentEnvironment{RpgNestedArea}{o o m}{
	\RpgArea[#1]{#3}

	\begin{RpgMap}[#2]
}{\end{RpgMap}}


\NewDocumentCommand{\RpgMapRef}{s m}{
	\IfBooleanTF{#1}
	{
		\nameref{#2}
	}
	{
		\nameref{#2}:~\nameref{rpg__expanded:#2}
	}
}

\NewDocumentCommand{\RpgMapRefPage}{s m}
{
	\IfBooleanTF{#1}{\RpgMapRef*{#2}}{\RpgMapRef{#2}}~\RpgPage[p]{#2}
}

\NewDocumentCommand{\RpgShowMapRefs}{}
{
	\bool_set_true:N \l__rpg_emergency_show_labels_bool
}
