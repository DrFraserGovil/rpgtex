
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Card-switching environments
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%Change the value of card mode
% \NewDocumentCommand{\RpgUseCards}{m}{\__rpg_set_bool_from_text:Ne \g__rpg_card_active_bool{#1}}
% \NewDocumentCommand{\RpgToggleUseCards}{}{\bool_set_inverse:N \g__rpg_card_active_bool}
\ExplSyntaxOn
\prop_new:N \g__rpg_switch_prop


\NewDocumentCommand{\RpgSetSwitch}{m m}{

	\prop_gput:Nnx \g__rpg_switch_prop{#1}{\__rpg_bool_from_text:e{#2}}
}
\NewDocumentCommand{\RpgSetAllSwitches}{m}{

	\prop_map_inline:Nn \g__rpg_switch_prop
    {
		\prop_gput:Nnx \g__rpg_switch_prop { ##1 } { \__rpg_bool_from_text:e{#1}}
	}
}


\cs_new_protected:Npn \__if_switch:nnn#1#2#3
{
	\prop_if_in:NnTF \g__rpg_switch_prop {#1}
    {
        % If key exists, retrieve the stored value (the boolean control sequence)
        \tl_set:Nf \l_tmpa_tl { \prop_item:Nn \g__rpg_switch_prop {#1} }
    }
    {
        % If key does NOT exist, use the safe false fallback
        \tl_set:Nn \l_tmpa_tl { \c_false_bool }
    }
	
	\exp_args:Ne \bool_if:NTF { \l_tmpa_tl } {#2} {#3}
}


%Renders text in one environment (#3) if 'card mode' active, otherwise uses a different environment (#5)
%Allows the same text to be rendered in either plain text or in a card.
\NewDocumentEnvironment{RpgSwitchEnvironment}{m O{} m O{} m}
{
	%#1 = switch name, #2 = env1 optional args, #3 = env1 definition, #4 = env2 optional args, #5 = env2 definition


	\__if_switch:nnn{#1}
	{
		\tl_gset:Ne \g_rpg_env_choice{#3}
		\tl_set:Ne\l_rpg_opts{#2}

	}
	{
		\tl_gset:Ne \g_rpg_env_choice{#5}
		\tl_set:Ne\l_rpg_opts{#4}
	}

	\tl_if_empty:eTF{\l_rpg_opts}
	{
		\begin{\g_rpg_env_choice}
	}
	{
		%%have to do this in stages, because we want to save \begin, but fully expand the opts.
		\tl_set:Nn \l_tmpa{ \begin{\g_rpg_env_choice}}
		\tl_set:Ne \l_tmpb {[\l_rpg_opts]}
		\tl_concat:NNN\l_rpg_begin_cmd\l_tmpa\l_tmpb

		%%actually execute the begin
		\exp_args:Ne \l_rpg_begin_cmd{}
	}
}
{
	\end{\g_rpg_env_choice}
}

%A clever little hack: so long as both environments take the same number of arguments, they will automatically be consumed:
%\RpgSwitchEnvironment[o1]{env1}[o2]{env2}{arg1}{arg2} expands to {env1}[o1}{arg1}{arg2} or {env2}[o2]{arg1}{arg2}
%This allows arbitrary environment arguments to be passed, so long as both env1 and env2 use the same pattern
\ExplSyntaxOff
