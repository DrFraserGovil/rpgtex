% Special Columns
\newcolumntype {Y} { > {\centering\arraybackslash } X }
\newcolumntype {`} { > {\global\let\currentrowstyle\relax } }
\newcolumntype {^} { > {\currentrowstyle} }


% Matches {, }, >,  , and any other character
\regex_const:Nn \c__preamble_regex {>\s*{.*}\s*\S|\S}

\newcommand{\rowstyle}[1]
  {
    \gdef\currentrowstyle{#1}#1\ignorespaces
  }

  % Table options
\__rpg_add_tl_keys:Nn{rpg/table}
{
	\__rpg_tl_key:nnn{color}{\l__rpg_table_color_tl}{tablecolor}
	\__rpg_tl_key:nnn{title}{\l__rpg_table_header_tl}{}
	\__rpg_tl_key:nnn{width}{\l__rpg_table_width_dim}{\linewidth}
	\__rpg_bool_key:nn{breakable}{\l__rpg_table_breakable_bool}
	\__rpg_bool_key:nn{noheader}{\l__rpg_table_noheader_bool}
	\__rpg_bool_key:nn{simple}{\l__rpg_table_simple_bool}
	\__rpg_bool_key:nn{filigree}{\l__rpg_table_filigree_bool}
	\__rpg_tl_key:nnn{vskip}{\l__table_vskip}{9pt plus 3pt minus 3pt}
}

\cs_new_protected:Npn \__write_table_title:n #1
{
	 \tl_if_empty:NF #1
    {
      \group_begin:
        \RpgFontTableTitle #1 \nopagebreak
        \par \vspace{ 5pt plus 2pt minus 2pt } \noindent
      \group_end:
    }
}

\cs_new_protected:Npn \__fancy_table:nnn#1#2#3
{
	{\RpgFontTableBody

	\rowcolors {1} {} {\l__rpg_table_color_tl}

	\bool_if:NTF \l__rpg_table_noheader_bool
	{
		\begin{#1} {\l__rpg_table_width_dim} {#2}
	}
	{
		\regex_extract_all:NnNTF \c__preamble_regex {#2} \l_tmpa_seq
		{
			\tl_set:Nn \l_tmpa_tl {\seq_use:Nn \l_tmpa_seq {^}}
			\use:x { \exp_not:n {\begin}{#1}{\l__rpg_table_width_dim}{`\l_tmpa_tl}}
			\rowstyle{\RpgFontTableHeader}
		}
		{
			\begin{#1} {\l__rpg_table_width_dim} {#2}
		}
	}
	#3
	\end{#1}
	}
}

\cs_new_protected:Npn \__simple_table:nn#1#2
{
	{\RpgFontTableBody

	\rowcolors {1} {} {\l__rpg_table_color_tl}
		\begin{tabular}{#1}
			#2
		\end{tabular}
	}
}
