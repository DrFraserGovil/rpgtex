
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Map Areas and their References
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ExplSyntaxOn

\input{core/lowlevel/map}
 \keys_define:nn { rpg / areas }
  {
	header-offset 	.tl_set:N 			= \l__rpg_manual_level_tl,
	header-offset	.value_required:n 	= true,
	header-offset	.initial:n			= 1, 
	title	.tl_set:N			= \l__rpg_map_title_tl,
	title	.value_required:n	= true,
	title	.initial:n			={},
	prefix	.tl_set:N			=\l__rpg_map_prefix_tl,
	prefix	.value_required:n	=true,
	prefix	.initial:n			={},
	blank-prefix .tl_set:N		=\l__rpg_map_blank_prefix_tl,
	blank-prefix	.value_required:n	=true,
	blank-prefix	.initial:n			={Area~},
	ref-prefix .tl_set:N		=\l__rpg_map_ref_tl,
	ref-prefix .value_required:n	=true,
	ref-prefix	.initial:n	= {Map:},
  }

\bool_new:N \l__rpg_in_map_environment
\NewDocumentEnvironment{RpgMap}{O{}}
{
	\group_begin:  
	\bool_set_true:N \l__rpg_in_map_environment
	\__rpg_construct_parent_prefix:

	\IfNoValueF{#1}
	{
		\keys_set:nn { rpg / areas } {#1}

		\int_compare:nT { \value{RpgAreaDepth} = 1 }
		{
			\tl_if_empty:eF \l__rpg_map_title_tl
			{
				\__rpg_render_heading_level:nf {\l__rpg_manual_level_tl{}}{\l__rpg_map_title_tl} 
			}
		}
	}
}
{
	\__rpg_end_map_block:
	\bool_set_false:N \l__rpg_in_map_environment
	\group_end:
}


\NewDocumentEnvironment{RpgMap*}{o}
{
	\group_begin:   
	\bool_set_true:N\l__rpg_map_starred_bool
	\begin{RpgMap}[#1]
}
{
	\end{RpgMap}
	\group_end:
}

\msg_new:nnn{rpg}{not-in-map}{Cannot~create~an~Area~without~an~RpgMap.}
\NewDocumentCommand{\RpgArea}{o m}
{
	\bool_if:NF\l__rpg_in_map_environment
	{
		\msg_error:nn{rpg}{not-in-map}
	}
	\IfNoValueF{#1}
	{
		\bool_set_true:N \l__use_label
		\tl_set:Ne \l__label{#1}
	}

	\__rpg_map_increment_counter:
	
	\__rpg_map_construct_title:n {#2}

	\bool_set_false:N \l__use_label

	%%Chceck if called as an environment, if so, activate subenvironment
	\str_compare:eNeT{\@currenvir}{=}{RpgArea}
	{
		\begin{RpgMap}
	}
}

%% Spoof in an end-environment command to end the subenvironment
\NewDocumentCommand{\endRpgArea}{}{\end{RpgMap}}


\tl_new:N \l__inserted_code
\NewDocumentCommand{\RpgMapRef}{s m}{
	\IfBooleanTF{#1}
	{
		\nameref{#2}
	}
	{
		\nameref{#2}~(\nameref{rpg__expanded:#2}\l__inserted_code)
	}
}

\NewDocumentCommand{\RpgMapRefPage}{s m}
{
	
	\IfBooleanTF{#1}{\RpgMapRef*{#2}~(\RpgPage{#2})}{\tl_set:Nn{\l__inserted_code}{,~\RpgPage{#2}}\RpgMapRef{#2}}
}

\NewDocumentCommand{\RpgShowMapRefs}{}
{
	\bool_set_true:N \l__rpg_emergency_show_labels_bool
}
